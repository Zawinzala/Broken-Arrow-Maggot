<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TNMKLQ79MK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-TNMKLQ79MK');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç©å®¶è¡Œä¸ºåˆ†æ v3.34 - By Zola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¢åŠ  overflow-x-hidden é˜²æ­¢ç§»åŠ¨ç«¯æ¨ªå‘æ»šåŠ¨ */
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .bar-container { background: rgba(0,0,0,0.5); height: 6px; border-radius: 4px; overflow: hidden; flex: 1; } 
        @media (min-width: 768px) { .bar-container { height: 8px; } }
        
        .bar-kill { background: #22c55e; height: 100%; transition: width 0.6s ease-out; }
        .bar-loss { background: #ef4444; height: 100%; transition: width 0.6s ease-out; }
        .bar-obj { background: #3b82f6; height: 100%; transition: width 0.6s ease-out; }
        
        .load-progress-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; margin: 12px 0; }
        .load-progress-fill { width: 0%; height: 100%; background: #06b6d4; transition: width 0.4s ease; box-shadow: 0 0 15px rgba(6,182,212,0.6); }

        .maggot-meter-bg { background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%); height: 18px; border-radius: 9px; position: relative; }
        .maggot-indicator { position: absolute; top: -4px; width: 6px; height: 26px; background: white; border: 2px solid #000; transform: translateX(-50%); transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* --- è´´çº¸å®¹å™¨ (å³ä¾§ - è¯„ä»·) --- */
        .tag-sticker-container { position: absolute; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; z-index: 30; transform-origin: top right; transform: scale(0.75); pointer-events: none; }
        @media (min-width: 768px) { .tag-sticker-container { top: 1.5rem; right: 1.5rem; gap: 0.75rem; transform: scale(1); } }
        
        /* --- è´´çº¸å®¹å™¨ (å·¦ä¾§ - ç´¯è®¡çˆ±ç”¨å•ä½) --- */
        .tag-sticker-container-left { position: absolute; top: 1rem; left: 1rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-start; z-index: 30; transform-origin: top left; transform: scale(0.75); pointer-events: none; }
        @media (min-width: 768px) { .tag-sticker-container-left { top: 1.5rem; left: 1.5rem; gap: 0.75rem; transform: scale(1); } }

        .tag-sticker { 
            pointer-events: auto; 
            padding: 0.5rem 1.25rem; 
            border-radius: 0.75rem; 
            font-weight: 900; 
            font-style: italic; 
            font-size: 0.9rem; 
            text-transform: uppercase; 
            transform: rotate(8deg); 
            box-shadow: 0 6px 15px rgba(0,0,0,0.4); 
            border-width: 2px; 
            animation: tagPop 0.5s ease-out forwards; 
            opacity: 0; 
            white-space: nowrap; 
        }
        
        .tag-sticker-left {
            transform: rotate(-5deg);
            animation: tagPopLeft 0.5s ease-out forwards;
        }

        @keyframes tagPop { from { opacity: 0; transform: scale(0.5) rotate(20deg); } to { opacity: 1; transform: scale(1) rotate(8deg); } }
        @keyframes tagPopLeft { from { opacity: 0; transform: scale(0.5) rotate(-15deg); } to { opacity: 1; transform: scale(1) rotate(-5deg); } }
        
        .teammate-row { transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); min-height: 80px; cursor: pointer; } 
        @media (min-width: 768px) { .teammate-row { min-height: 85px; } }
        
        .teammate-row:hover { background: rgba(255,255,255,0.1) !important; }
        .teammate-row:active { background: rgba(255,255,255,0.15) !important; transform: scale(0.995); }
        .is-me { background: rgba(6, 182, 212, 0.15) !important; border-left: 3px solid #06b6d4; }
        @media (min-width: 768px) { .is-me { border-left-width: 5px; } }

        .id-link { cursor: pointer; color: #94a3b8; font-family: ui-monospace, monospace; font-size: 0.7rem; border-bottom: 1px dotted #64748b; width: fit-content; opacity: 0.7; max-width: 100%; overflow: hidden; text-overflow: ellipsis; }
        @media (min-width: 768px) { .id-link { font-size: 0.75rem; } }
        .id-link:hover { color: #22d3ee; border-bottom-color: #22d3ee; opacity: 1; }
        
        .history-chip { font-size: 0.85rem; padding: 6px 14px; background: #1e293b; border: 1px solid #475569; border-radius: 99px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .history-chip:hover { border-color: #06b6d4; color: #22d3ee; background: #0f172a; }
        .history-del { font-size: 1.1rem; line-height: 1; opacity: 0.5; }
        .result-fade { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Modal Styles */
        .modal-backdrop { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        .search-result-item:hover { background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.5); }
        
        .medal-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 2px;
            padding: 2px 4px; 
            border-radius: 4px; 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
            cursor: help;
            flex-shrink: 0; /* é˜²æ­¢æŒ¤å‹ï¼Œå¼ºåˆ¶æ¢è¡Œ */
        }
        @media (min-width: 768px) { .medal-badge { gap: 4px; padding: 2px 6px; border-radius: 6px; } }

        .medal-badge:hover { 
            background: rgba(255,255,255,0.15); 
            transform: translateY(-1px);
            border-color: rgba(255,255,255,0.2);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        
        /* å•å±€å•ä½æ ‡ç­¾æ ·å¼ - ç´§å‡‘å‹ */
        .match-unit-tag {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px; /* å°å­—ä½“ */
            line-height: 1.2;
            width: 100%;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            white-space: nowrap;
        }

        .stat-grid-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .stat-grid-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; }
        .stat-grid-value { font-size: 14px; font-weight: bold; color: #e2e8f0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    </style>
</head>
<body class="min-h-screen pt-4 px-2 pb-24 md:pt-10 md:px-4">

    <div class="w-full max-w-6xl mx-auto flex justify-between items-center mb-6 md:mb-8 px-2">
        <div class="flex gap-4 items-center">
            <a href="https://github.com/Zawinzala/Broken-Arrow-Maggot" target="_blank" class="flex items-center gap-2 px-3 py-1 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-slate-300 hover:text-white transition group">
                <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                <span class="text-[10px] md:text-xs font-mono font-bold">GitHub</span>
            </a>
            <div class="text-[10px] md:text-xs text-slate-400 font-mono tracking-widest uppercase font-bold">v3.34 Detail View</div>
        </div>
        <div class="flex gap-1 md:gap-2 bg-slate-800 p-1 rounded-xl border border-slate-700">
            <button onclick="setLang('en')" id="btn_lang_en" class="px-3 py-1 md:px-4 md:py-1.5 text-xs rounded-lg transition font-bold">English</button>
            <button onclick="setLang('zh')" id="btn_lang_zh" class="px-3 py-1 md:px-4 md:py-1.5 text-xs rounded-lg transition font-bold">ä¸­æ–‡</button>
            <button onclick="setLang('ru')" id="btn_lang_ru" class="px-3 py-1 md:px-4 md:py-1.5 text-xs rounded-lg transition font-bold">Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
            <button onclick="setLang('ja')" id="btn_lang_ja" class="px-3 py-1 md:px-4 md:py-1.5 text-xs rounded-lg transition font-bold">æ—¥æœ¬èª</button>
        </div>
    </div>

    <div class="glass-panel w-full max-w-6xl mx-auto rounded-[1.5rem] md:rounded-[2.5rem] p-5 md:p-10 shadow-2xl border-white/5">
        <div class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-6xl font-black text-white tracking-tighter mb-4 flex flex-col md:block items-center justify-center">
                <span id="lbl_title">ç©å®¶è¡Œä¸ºåˆ†æ</span>
                <span class="text-base md:text-xl text-cyan-500 italic mt-2 md:mt-0 md:ml-4 opacity-80 font-serif">By Zola</span>
            </h1>
            <div class="flex justify-center gap-6 mb-4">
                <a href="https://barmory.net/" target="_blank" class="text-xs text-slate-400 border border-slate-700 px-3 py-1 rounded-full hover:bg-slate-700 hover:text-white transition-all font-medium">Data Source: Barmory.net</a>
            </div>
            <p class="text-cyan-400 font-mono text-[10px] md:text-sm uppercase tracking-[0.2em] md:tracking-[0.4em] font-bold" id="lbl_subtitle">Player Behavior Analysis</p>
        </div>

        <div class="flex flex-col items-center mb-10 md:mb-16">
            <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full max-w-2xl relative">
                <input type="text" id="steamInput" class="flex-1 bg-slate-900 border-2 border-slate-700 text-white p-4 md:p-5 rounded-xl md:rounded-2xl text-center text-base md:text-lg focus:ring-4 focus:ring-cyan-500/20 focus:border-cyan-500 outline-none transition-all placeholder-slate-600 shadow-2xl font-medium">
                <button onclick="handleCheck()" id="btn_check" class="bg-cyan-600 hover:bg-cyan-500 text-white font-black px-12 py-4 md:py-5 rounded-xl md:rounded-2xl shadow-xl transform active:scale-95 transition-all text-base md:text-lg whitespace-nowrap">å¼€å§‹æ£€æµ‹</button>
            </div>
            
            <div class="flex flex-row flex-wrap justify-center gap-2 md:gap-6 mt-4">
                <button onclick="openSearchModal()" class="text-slate-400 text-xs md:text-sm hover:text-orange-400 transition flex items-center gap-2 group p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:scale-110 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span id="lbl_find_id_btn" class="border-b border-dotted border-slate-600 group-hover:border-orange-400">ä¸çŸ¥é“ IDï¼Ÿé€šè¿‡ç”¨æˆ·åæŸ¥æ‰¾</span>
                </button>

                <button onclick="openMatchSearchModal()" class="text-slate-400 text-xs md:text-sm hover:text-cyan-400 transition flex items-center gap-2 group p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:scale-110 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <span id="lbl_find_match_btn" class="border-b border-dotted border-slate-600 group-hover:border-cyan-400">åªçŸ¥é“å¯¹å±€ IDï¼Ÿé€šè¿‡å¯¹å±€æŸ¥ç©å®¶</span>
                </button>
            </div>
            
            <div id="historyContainer" class="flex flex-wrap justify-center gap-2 md:gap-3 mt-6 md:mt-8"></div>
        </div>

        <div id="loading" class="hidden text-center py-12 max-w-lg mx-auto">
            <div class="flex justify-between text-sm font-bold text-slate-300 mb-2">
                <span id="loadStatus">Initializing...</span>
                <span id="loadPercent">0%</span>
            </div>
            <div class="load-progress-bg"><div id="loadProgressFill" class="load-progress-fill"></div></div>
            <p class="text-xs text-slate-500 mt-3 font-mono font-medium" id="loadDetail">Synchronizing Data Chains...</p>
        </div>

        <div id="errorArea" class="hidden mb-10 max-w-2xl mx-auto bg-red-900/30 border border-red-500/50 text-red-100 p-6 rounded-3xl text-base text-center font-bold">
            <span id="errorMsg">Unknown Error</span>
        </div>

        <div id="resultPanel" class="hidden result-fade">
            <div class="bg-slate-800/60 rounded-[2rem] md:rounded-[3rem] p-6 md:p-12 border border-white/10 flex flex-col items-center mb-10 md:mb-16 relative overflow-hidden">
                <!-- å³ä¾§è¯„ä»·è´´çº¸ -->
                <div class="tag-sticker-container"></div>
                <!-- å·¦ä¾§ç´¯è®¡çˆ±ç”¨å•ä½è´´çº¸ -->
                <div class="tag-sticker-container-left" id="unitStickerContainer"></div>

                <div class="text-center mb-4 mt-2 md:mt-0 w-full px-2">
                    <div id="userNameDisplay" class="text-xl md:text-3xl font-black text-white mb-2 truncate">Commander Name</div>
                    <div id="calcTimeDisplay" class="text-[10px] font-mono text-slate-500 uppercase tracking-widest">Calculated: 2024-01-01 00:00:00</div>
                </div>

                <h2 class="text-slate-400 text-xs md:text-sm font-black uppercase tracking-[0.2em] mb-2" id="lbl_maggot_index_title">ç»¼åˆè¯„ä»·</h2>
                <div class="text-[6rem] md:text-[10rem] font-black text-white leading-none mb-4 md:mb-6" id="maggotScoreDisplay" style="text-shadow: 0 5px 25px rgba(0,0,0,0.4);">1.0</div>
                <div id="maggotLabel" class="text-xl md:text-3xl font-black px-8 py-2 md:px-10 md:py-3 rounded-full bg-slate-900 border-2 border-white/10 shadow-2xl mb-8 md:mb-12">Unknown</div>
                
                <div class="w-full max-w-3xl mb-8 md:mb-12">
                    <div class="flex justify-between text-[10px] md:text-xs text-slate-400 mb-4 uppercase font-black tracking-widest">
                        <span id="lbl_god_range">ç¥</span><span id="lbl_maggot_range">è›†</span>
                    </div>
                    <div class="maggot-meter-bg"><div id="meterIndicator" class="maggot-indicator" style="left: 0%;"></div></div>
                </div>

                <div class="w-full max-w-5xl grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6 pt-8 md:pt-10 border-t-2 border-white/5">
                    <div class="text-center">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_kdr">å¹³å‡ KD æ’å</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-cyan-400" id="ref_avgKDR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_kr">å¹³å‡å‡»æ€æ’å</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-green-400" id="ref_avgKR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_dr">çˆ±å…µå¦‚å­æ’å</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-red-400" id="ref_avgDR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_or">å¹³å‡å ç‚¹æ’å</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-blue-400" id="ref_avgOR">#0.0</div>
                    </div>
                    <div class="text-center col-span-2 md:col-span-1">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_wr">æœ€è¿‘ 12 å±€èƒœç‡</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-yellow-400" id="ref_WR">0%</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4 md:gap-6 mb-8 md:mb-12">
                <div class="h-[2px] flex-1 bg-white/10"></div>
                <h3 class="text-lg md:text-2xl font-black text-slate-200 uppercase tracking-widest text-center" id="lbl_history_title">æœ€è¿‘ 12 å±€æœ‰æ•ˆå¯¹å±€</h3>
                <div class="h-[2px] flex-1 bg-white/10"></div>
            </div>
            <div id="matchesContainer" class="space-y-8 md:space-y-16"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="idSearchModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 relative shadow-2xl bg-slate-900/90 border border-slate-600">
            <button onclick="closeSearchModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 id="modal_title" class="text-xl md:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500 mb-1 text-center">ç©å®¶å†…éƒ¨ ID æŸ¥è¯¢</h2>
            <div class="text-[10px] text-slate-500 mb-6 text-center font-mono">Data from: <a href="https://dash.aoeiaol.top/" target="_blank" class="hover:text-orange-400 border-b border-dotted border-slate-600 transition">https://dash.aoeiaol.top/</a></div>
            <div class="flex gap-2 mb-2">
                <input type="text" id="modalSearchInput" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-3 placeholder-slate-500" placeholder="è¾“å…¥æ¸¸æˆç”¨æˆ·å..." onkeydown="if(event.key === 'Enter') doNameSearch()">
                <button onclick="doNameSearch()" id="modal_btn_search" class="text-white bg-orange-600 hover:bg-orange-700 focus:ring-4 focus:outline-none focus:ring-orange-800 font-medium rounded-lg text-sm px-6 py-3 transition whitespace-nowrap">æŸ¥è¯¢</button>
            </div>
            <div id="modalStatusMsg" class="text-xs text-slate-400 min-h-[1.5rem] mb-2 pl-1"></div>
            <div id="modalResultList" class="hidden rounded-xl overflow-hidden max-h-[300px] overflow-y-auto flex flex-col gap-1 pr-1 custom-scrollbar"></div>
            <div id="modalFinalResult" class="hidden mt-4 bg-orange-900/10 border border-orange-500/20 rounded-xl p-4 text-center">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider mb-1" id="lbl_modal_pname">ç©å®¶åç§°</div>
                <div id="modalSelectedName" class="text-xl font-bold text-white mb-2"></div>
                <div class="text-slate-400 text-[10px] uppercase tracking-wider mb-1" id="lbl_modal_pid">å†…éƒ¨ ID</div>
                <div class="flex items-center justify-center gap-2 mb-3">
                    <code id="modalSelectedId" class="bg-black/30 px-3 py-1 rounded text-orange-300 font-mono text-xl font-bold select-all"></code>
                </div>
                <button onclick="useFoundId()" id="btn_use_id" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 rounded-lg shadow-lg transition">ä½¿ç”¨æ­¤ ID æ£€æµ‹</button>
            </div>
        </div>
    </div>

    <div id="matchSearchModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop p-4">
        <div class="glass-panel w-full max-w-4xl rounded-2xl p-6 relative shadow-2xl bg-slate-900/95 border border-slate-600 flex flex-col max-h-[90vh]">
            <button onclick="closeMatchSearchModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 id="modal_match_title" class="text-xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-6 text-center">é€šè¿‡å¯¹å±€ ID æŸ¥æ‰¾ç©å®¶</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="matchIdInput" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-xl focus:ring-cyan-500 focus:border-cyan-500 block w-full p-4 placeholder-slate-500 font-mono" placeholder="è¾“å…¥å¯¹å±€ ID..." onkeydown="if(event.key === 'Enter') doMatchSearch()">
                <button onclick="doMatchSearch()" id="modal_match_btn_search" class="text-white bg-cyan-600 hover:bg-cyan-500 focus:ring-4 focus:outline-none focus:ring-cyan-800 font-bold rounded-xl text-sm px-6 py-4 transition whitespace-nowrap">è·å–æˆ˜ç»©</button>
            </div>
            <div id="matchModalStatus" class="text-xs mb-4 pl-1 text-center min-h-[1rem]"></div>
            <div id="matchModalResultArea" class="hidden flex-1 overflow-y-auto custom-scrollbar pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="matchModalTeam0" class="space-y-1"></div>
                    <div id="matchModalTeam1" class="space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Detail Modal -->
    <div id="playerDetailModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-backdrop p-4">
        <div class="glass-panel w-full max-w-2xl rounded-2xl p-6 relative shadow-2xl bg-slate-900/95 border border-slate-600 flex flex-col max-h-[90vh]">
            <button onclick="closePlayerDetailModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white z-10 p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div class="text-center mb-6">
                <h2 id="pd_name" class="text-2xl font-black text-white">Player Name</h2>
                <div class="flex justify-center gap-4 mt-2 text-xs text-slate-400 font-mono">
                    <span id="pd_id">ID: 123456</span>
                    <span id="pd_elo" class="text-cyan-400">ELO 1200 (+15.0)</span>
                </div>
            </div>
            
            <div class="overflow-y-auto custom-scrollbar pr-2 flex-1">
                <!-- Basic Stats -->
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <div class="stat-grid-item bg-green-900/20 border-green-500/30">
                        <div class="stat-grid-label text-green-300" id="lbl_pd_kill">å‡»æ€åˆ†</div>
                        <div class="stat-grid-value text-green-100" id="pd_kill">0</div>
                    </div>
                    <div class="stat-grid-item bg-red-900/20 border-red-500/30">
                        <div class="stat-grid-label text-red-300" id="lbl_pd_loss">æŸå¤±åˆ†</div>
                        <div class="stat-grid-value text-red-100" id="pd_loss">0</div>
                    </div>
                    <div class="stat-grid-item bg-blue-900/20 border-blue-500/30">
                        <div class="stat-grid-label text-blue-300" id="lbl_pd_obj">å ç‚¹åˆ†</div>
                        <div class="stat-grid-value text-blue-100" id="pd_obj">0</div>
                    </div>
                    <div class="stat-grid-item bg-yellow-900/20 border-yellow-500/30">
                        <div class="stat-grid-label text-yellow-300">K/D</div>
                        <div class="stat-grid-value text-yellow-100" id="pd_kd">0.00</div>
                    </div>
                </div>

                <!-- Detailed Stats -->
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 border-b border-white/10 pb-1">Detailed Stats</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4">
                    <div class="stat-grid-item"><div class="stat-grid-label" id="lbl_pd_dmg_dealt">ä¼¤å®³è¾“å‡º</div><div class="stat-grid-value text-orange-400" id="pd_dmg_dealt">0</div></div>
                    <div class="stat-grid-item"><div class="stat-grid-label" id="lbl_pd_dmg_taken">æ‰¿å—ä¼¤å®³</div><div class="stat-grid-value text-slate-400" id="pd_dmg_taken">0</div></div>
                    <div class="stat-grid-item"><div class="stat-grid-label" id="lbl_pd_supply">è¡¥ç»™æ¶ˆè€—</div><div class="stat-grid-value text-yellow-400" id="pd_supply">0</div></div>
                    <div class="stat-grid-item"><div class="stat-grid-label" id="lbl_pd_supply_ally">åƒç›Ÿå‹è¡¥ç»™</div><div class="stat-grid-value text-pink-400" id="pd_supply_ally">0</div></div>
                    <div class="stat-grid-item"><div class="stat-grid-label" id="lbl_pd_supply_give">å–‚ç›Ÿå‹è¡¥ç»™</div><div class="stat-grid-value text-green-400" id="pd_supply_give">0</div></div>
                    <div class="stat-grid-item"><div class="stat-grid-label" id="lbl_pd_units">å•ä½æ€»å€¼</div><div class="stat-grid-value text-blue-400" id="pd_units">0</div></div>
                </div>

                <!-- Top Units -->
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 border-b border-white/10 pb-1">Top Units</h3>
                <div class="grid grid-cols-1 gap-2">
                    <div class="bg-slate-800/50 rounded p-2 flex justify-between items-center border-l-2 border-orange-500">
                        <div class="text-xs text-orange-300 font-bold" id="lbl_pd_top_dmg">æœ€é«˜ä¼¤å®³</div>
                        <div class="text-right"><div class="text-xs text-white font-bold" id="pd_top_dmg_name">-</div><div class="text-[10px] text-slate-400" id="pd_top_dmg_val">0</div></div>
                    </div>
                    <div class="bg-slate-800/50 rounded p-2 flex justify-between items-center border-l-2 border-red-500">
                        <div class="text-xs text-red-300 font-bold" id="lbl_pd_top_kill">æœ€é«˜å‡»æ€</div>
                        <div class="text-right"><div class="text-xs text-white font-bold" id="pd_top_kill_name">-</div><div class="text-[10px] text-slate-400" id="pd_top_kill_val">0</div></div>
                    </div>
                    <div class="bg-slate-800/50 rounded p-2 flex justify-between items-center border-l-2 border-blue-500">
                        <div class="text-xs text-blue-300 font-bold" id="lbl_pd_top_tank">æœ€é«˜æ‰¿ä¼¤</div>
                        <div class="text-right"><div class="text-xs text-white font-bold" id="pd_top_tank_name">-</div><div class="text-[10px] text-slate-400" id="pd_top_tank_val">0</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            MATCH_GOAL: 12,
            MIN_PLAYERS: 10,
            PROXIES: [
                { name: "Codetabs", url: (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}` },
                { name: "CorsProxy", url: (u) => `https://corsproxy.io/?${encodeURIComponent(u)}` },
                { name: "AllOrigins", url: (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}&cb=${Date.now()}` }
            ]
        };

        const MEDAL_CONFIG = [
            { key: 'Destruction', icon: 'âš”ï¸', color: 'text-red-400' },
            { key: 'Losses', icon: 'â˜ ï¸', color: 'text-gray-400' }, 
            { key: 'DamageDealt', icon: 'ğŸ’¥', color: 'text-orange-400' }, 
            { key: 'DamageReceived', icon: 'ğŸ§±', color: 'text-slate-400' }, 
            { key: 'SupplyPointsConsumed', icon: 'ğŸ”', color: 'text-yellow-400' }, 
            { key: 'SupplyPointsConsumedFromAllies', icon: 'ğŸ±', color: 'text-pink-400' }, 
            { key: 'SupplyPointsConsumedByAllies', icon: 'ğŸš‘', color: 'text-green-400' }, 
            { key: 'TotalSpawnedUnitScore', icon: 'ğŸ›’', color: 'text-blue-400' }, 
            { key: 'TotalRefundedUnitScore', icon: 'ğŸ’¸', color: 'text-emerald-400' }
        ];

        let UNIT_NAME_CACHE = {};
        let IS_UNIT_CACHE_LOADED = false;
        let CURRENT_MATCH_STATS = []; // Store stats globally for detail view
        const UNIT_CACHE_KEY = 'ba_unit_dict';
        const UNIT_CACHE_TS_KEY = 'ba_unit_dict_ts';

        const DICT = {
            zh: {
                title: "ç©å®¶è¡Œä¸ºåˆ†æ", subtitle: "Broken Arrow Behavior Analysis", 
                placeholder: "Steam64 ID æˆ– æ¸¸æˆå†…éƒ¨æ•°å­— ID...", 
                check: "å¼€å§‹æ£€æµ‹", loading: "åŒæ­¥ä¸­...", maggot_index_title: "ç»¼åˆè¯„ä»·",
                god_range: "ç¥", avg_range: " ", maggot_range: "è›†",
                history_title: "æœ€è¿‘ 12 å±€æœ‰æ•ˆå¯¹å±€", 
                find_id_btn: "ä¸çŸ¥é“ IDï¼Ÿé€šè¿‡ç”¨æˆ·åæŸ¥æ‰¾",
                find_match_btn: "åªçŸ¥é“å¯¹å±€ IDï¼Ÿé€šè¿‡å¯¹å±€æŸ¥ç©å®¶",
                modal_title: "ç©å®¶å†…éƒ¨ ID æŸ¥è¯¢", modal_input_ph: "è¾“å…¥æ¸¸æˆç”¨æˆ·å...", modal_btn_search: "æŸ¥è¯¢",
                modal_pname: "ç©å®¶åç§°", modal_pid: "å†…éƒ¨ ID", modal_use_btn: "ä½¿ç”¨æ­¤ ID æ£€æµ‹",
                modal_status_search: "æœç´¢ä¸­...", modal_status_err: "å‡ºé”™äº†: ", modal_status_none: "æœªæ‰¾åˆ°è¯¥ç©å®¶",
                modal_status_found: "æ‰¾åˆ° {n} ä¸ªç»“æœ",
                
                modal_match_title: "é€šè¿‡å¯¹å±€ ID æŸ¥æ‰¾ç©å®¶",
                modal_match_input_ph: "è¾“å…¥å¯¹å±€ ID (å¦‚ 184523)...",
                modal_match_btn_search: "è·å–æˆ˜ç»©",
                modal_match_loading: "æ­£åœ¨è·å–å¯¹å±€ä¿¡æ¯...",
                modal_match_err: "è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ID æ˜¯å¦æ­£ç¡®",

                kill: "å‡»æ€", loss: "æŸå¤±", obj: "å ç‚¹",
                levels: ["ğŸ‘‘ ç¥", "ğŸ¦ å›¢é˜Ÿæ”¯æŸ±", "ğŸ˜ å¹³å¹³æ·¡æ·¡", "ğŸ› æœ‰ç‚¹è›†", "ğŸ’© è›†ï¼"],
                tag_killer: "âš”ï¸ å‡»æ€ä¸ºä¸»", tag_kd: "ğŸ“ˆ KD ä¸ºä¸»", tag_obj: "ğŸš© å ç‚¹ä¸ºä¸»",
                trend_up: "ğŸš€ æœ€è¿‘å˜å¼º", trend_down: "ğŸ“‰ æœ€è¿‘å˜è›†", trend_flat: "â¡ï¸ ç¨³å¦‚æ³°å±±",
                err_net: "ç½‘ç»œæ‹¥å¡ï¼Œè¯·ç¨åå†è¯•", err_insufficient: "æœ‰æ•ˆå¯¹å±€ä¸è¶³ 12 å±€",
                lbl_ref_kdr: "å¹³å‡ KD æ’å", lbl_ref_kr: "å¹³å‡å‡»æ€æ’å",
                lbl_ref_dr: "çˆ±å…µå¦‚å­æ’å", lbl_ref_or: "å¹³å‡å ç‚¹æ’å", lbl_ref_wr: "æœ€è¿‘ 12 å±€èƒœç‡",
                res_vic: "èƒœåˆ©", res_def: "å¤±è´¥", res_draw: "å¹³å±€",
                meta_map: "åœ°å›¾", meta_dur: "æ—¶é•¿", meta_win: "è·èƒœæ–¹",
                reasons: { 1: "ç»Ÿæ²»ç»“æŸ", 2: "æ­£å¸¸ç»“æŸ", 3: "æŠ•é™ç»“æŸ" },
                medals: {
                    Destruction: "å‡»æ€ç‹", Losses: "é€æ­»ç‹", DamageDealt: "ç‚¸ç‚¸ç‚¸", DamageReceived: "è€ç‚¸ç‹",
                    SupplyPointsConsumed: "å¤§èƒƒè¢‹", SupplyPointsConsumedFromAllies: "å°é¦‹çŒ«", SupplyPointsConsumedByAllies: "å¥¶å¦ˆ", 
                    TotalSpawnedUnitScore: "é‡‡è´­å®˜", TotalRefundedUnitScore: "ä»…é€€æ¬¾"
                },
                medal_descs: {
                    Destruction: "å‡»æ€å¾—åˆ†å…¨é˜Ÿæœ€é«˜", 
                    Losses: "æŸå¤±å¾—åˆ†å…¨é˜Ÿæœ€é«˜ (é€åˆ†æœ€å¤š)", 
                    DamageDealt: "å¯¹æ•Œé€ æˆä¼¤å®³æ€»é‡å…¨é˜Ÿæœ€é«˜", 
                    DamageReceived: "æ‰¿å—ä¼¤å®³æ€»é‡å…¨é˜Ÿæœ€é«˜",
                    SupplyPointsConsumed: "æ¶ˆè€—è¡¥ç»™æ€»åˆ†å…¨é˜Ÿæœ€é«˜", 
                    SupplyPointsConsumedFromAllies: "æ¶ˆè€—ç›Ÿå‹è¡¥ç»™åˆ†æ•°å…¨é˜Ÿæœ€é«˜", 
                    SupplyPointsConsumedByAllies: "æä¾›ç»™ç›Ÿå‹è¡¥ç»™åˆ†æ•°å…¨é˜Ÿæœ€é«˜", 
                    TotalSpawnedUnitScore: "æ‹›å‹Ÿå•ä½æ€»åˆ†å…¨é˜Ÿæœ€é«˜", 
                    TotalRefundedUnitScore: "é€€æ¬¾å•ä½æ€»åˆ†å…¨é˜Ÿæœ€é«˜"
                },
                trend_desc: "æœ€è¿‘ 6 å±€æ’åä¸å†å²å¹³å‡æ’åçš„å¯¹æ¯”è¶‹åŠ¿",
                elo_desc: "æœ€æ–°çš„ ELO è¯„åˆ† (åŸºäºæœ€æ–°ä¸€å±€æ•°æ®)",
                
                // New
                lbl_fav_units_title: "ç©å®¶æœ€çˆ±å•ä½ (æœ€è¿‘ 12 å±€ç´¯è®¡)",
                lbl_fav_dmg: "è¾“å‡ºæœºå™¨ (Total Dmg)",
                lbl_fav_kill: "å‡»æ€æœºå™¨ (Total Kills)",
                lbl_fav_tank: "æŠ—å‹æœºå™¨ (Total Taken)",
                
                unit_dmg_title: "æœ€é«˜ä¼¤å®³",
                unit_kill_title: "æœ€é«˜å‡»æ€",
                unit_tank_title: "æœ€é«˜æ‰¿ä¼¤",

                // Detail Modal
                pd_dmg_dealt: "ä¼¤å®³è¾“å‡º", pd_dmg_taken: "æ‰¿å—ä¼¤å®³",
                pd_supply: "è¡¥ç»™æ¶ˆè€—", pd_supply_ally: "åƒç›Ÿå‹è¡¥ç»™", pd_supply_give: "å–‚ç›Ÿå‹è¡¥ç»™",
                pd_units: "å•ä½æ€»å€¼"
            },
            en: {
                title: "Player Behavior Analysis", 
                subtitle: "Broken Arrow Analytics", 
                placeholder: "Steam64 ID or In-Game Numeric ID...", 
                check: "ANALYZE", 
                loading: "Syncing...", 
                maggot_index_title: "PERFORMANCE RATING",
                god_range: "GOD", 
                avg_range: " ", 
                maggot_range: "MAGGOT",
                history_title: "Last 12 Valid Matches",
                
                find_id_btn: "Forgot ID? Search by Name",
                find_match_btn: "Have Match ID? Search Players",
                
                modal_title: "Player Internal ID Lookup", 
                modal_input_ph: "Enter Username...", 
                modal_btn_search: "Search",
                modal_pname: "Player Name", 
                modal_pid: "Internal ID", 
                modal_use_btn: "Analyze This ID",
                modal_status_search: "Searching...", 
                modal_status_err: "Error: ", 
                modal_status_none: "No players found",
                modal_status_found: "Found {n} results",

                modal_match_title: "Search Player by Match ID",
                modal_match_input_ph: "Enter Match ID (e.g. 184523)...",
                modal_match_btn_search: "Fetch Stats",
                modal_match_loading: "Retrieving match data...",
                modal_match_err: "Failed to fetch match info",

                kill: "Kills", loss: "Losses", obj: "Caps",
                levels: ["ğŸ‘‘ GODLIKE", "ğŸ¦ CARRY", "ğŸ˜ AVERAGE", "ğŸ› BitMaggot", "ğŸ’© MAGGOT!"],
                
                tag_killer: "âš”ï¸ Fragger", 
                tag_kd: "ğŸ“ˆ KD Player", 
                tag_obj: "ğŸš© PTFO", 
                
                trend_up: "ğŸš€ On the Rise", 
                trend_down: "ğŸ“‰ Slumping", 
                trend_flat: "â¡ï¸ Consistent", 
                
                err_net: "Network congestion, please retry", 
                err_insufficient: "Insufficient data (Need 12+ matches)",
                
                lbl_ref_kdr: "KD Rating Rank", 
                lbl_ref_kr: "Kill Rating Rank",
                lbl_ref_dr: "Unit Preservation Rank", 
                lbl_ref_or: "Objective Rank", 
                lbl_ref_wr: "Win Rate (Last 12)",
                
                res_vic: "VICTORY", res_def: "DEFEAT", res_draw: "DRAW",
                meta_map: "Map", meta_dur: "Time", meta_win: "Winner",
                reasons: { 1: "Domination", 2: "Time/Score", 3: "Surrender" },
                
                medals: {
                    Destruction: "Top Fragger", 
                    Losses: "Cannon Fodder",           
                    DamageDealt: "Heavy Hitter",       
                    DamageReceived: "Bullet Sponge",      
                    SupplyPointsConsumed: "Big Spender",   
                    SupplyPointsConsumedFromAllies: "Freeloader", 
                    SupplyPointsConsumedByAllies: "Medic",
                    TotalSpawnedUnitScore: "War Machine",
                    TotalRefundedUnitScore: "Refund King" 
                },
                
                medal_descs: {
                    Destruction: "Highest total value of enemy units destroyed (Raw Kill Score)", 
                    Losses: "Highest total value of own units lost (Feeder)", 
                    DamageDealt: "Highest total physical damage dealt to enemies", 
                    DamageReceived: "Highest total physical damage received",
                    SupplyPointsConsumed: "Most supply points spent on units/ammo", 
                    SupplyPointsConsumedFromAllies: "Most supply taken from teammates' stashes", 
                    SupplyPointsConsumedByAllies: "Most supply provided to teammates", 
                    TotalSpawnedUnitScore: "Highest total point value of units deployed", 
                    TotalRefundedUnitScore: "Highest total point value of units sold back"
                },
                
                trend_desc: "Performance trend over recent 6 matches vs history",
                elo_desc: "Current ELO Rating (Live update)",

                // New
                lbl_fav_units_title: "Favorite Units (Last 12 Matches)",
                lbl_fav_dmg: "Heavy Hitter (Total Dmg)",
                lbl_fav_kill: "Terminator (Total Kills)",
                lbl_fav_tank: "Damage Soaked (Total Taken)",

                unit_dmg_title: "Max Damage",
                unit_kill_title: "Max Kills",
                unit_tank_title: "Max Taken",

                // Detail Modal
                pd_dmg_dealt: "Damage Dealt", pd_dmg_taken: "Damage Received",
                pd_supply: "Supply Used", pd_supply_ally: "Taken from Ally", pd_supply_give: "Given to Ally",
                pd_units: "Unit Value"
            },
            ru: {
                title: "ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²",
                subtitle: "Broken Arrow Analytics",
                placeholder: "Steam64 ID Ğ¸Ğ»Ğ¸ Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ ID...",
                check: "ĞŸĞ ĞĞ’Ğ•Ğ Ğ˜Ğ¢Ğ¬",
                loading: "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ...",
                maggot_index_title: "ĞĞ‘Ğ©Ğ˜Ğ™ Ğ Ğ•Ğ™Ğ¢Ğ˜ĞĞ“",
                god_range: "Ğ‘ĞĞ“",
                avg_range: " ",
                maggot_range: "Ğ›Ğ˜Ğ§Ğ˜ĞĞšĞ",
                history_title: "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 12 Ğ¼Ğ°Ñ‚Ñ‡ĞµĞ¹",

                find_id_btn: "Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ ID? ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸",
                find_match_btn: "Ğ•ÑÑ‚ÑŒ ID Ğ¼Ğ°Ñ‚Ñ‡Ğ°? ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²",

                modal_title: "ĞŸĞ¾Ğ¸ÑĞº ID Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°",
                modal_input_ph: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ...",
                modal_btn_search: "ĞŸĞ¾Ğ¸ÑĞº",
                modal_pname: "Ğ˜Ğ¼Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°",
                modal_pid: "Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ ID",
                modal_use_btn: "ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ ID",
                modal_status_search: "ĞŸĞ¾Ğ¸ÑĞº...",
                modal_status_err: "ĞÑˆĞ¸Ğ±ĞºĞ°: ",
                modal_status_none: "Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹",
                modal_status_found: "ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ {n} Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²",

                modal_match_title: "ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ¿Ğ¾ ID Ğ¼Ğ°Ñ‚Ñ‡Ğ°",
                modal_match_input_ph: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ID Ğ¼Ğ°Ñ‚Ñ‡Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 184523)...",
                modal_match_btn_search: "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ",
                modal_match_loading: "ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¼Ğ°Ñ‚Ñ‡Ğ°...",
                modal_match_err: "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¼Ğ°Ñ‚Ñ‡Ğµ",

                kill: "Ğ£Ğ±Ğ¸Ğ¹ÑÑ‚Ğ²Ğ°", loss: "ĞŸĞ¾Ñ‚ĞµÑ€Ğ¸", obj: "Ğ¢Ğ¾Ñ‡ĞºĞ¸",
                levels: ["ğŸ‘‘ Ğ‘ĞĞ“", "ğŸ¦ Ğ¢ĞĞ©Ğ•Ğ ", "ğŸ˜ Ğ¡Ğ Ğ•Ğ”ĞĞ•", "ğŸ› ĞĞ•ĞœĞĞĞ“Ğ Ğ›Ğ˜Ğ§Ğ˜ĞĞšĞ", "ğŸ’© Ğ›Ğ˜Ğ§Ğ˜ĞĞšĞ!"],

                tag_killer: "âš”ï¸ Ğ¤Ñ€Ğ°Ğ³ĞµÑ€",
                tag_kd: "ğŸ“ˆ ĞšĞ” Ğ˜Ğ³Ñ€Ğ¾Ğº",
                tag_obj: "ğŸš© ĞĞ±ÑŠĞµĞºÑ‚Ğ¸Ğ²",

                trend_up: "ğŸš€ ĞĞ° Ğ¿Ğ¾Ğ´ÑŠĞµĞ¼Ğµ",
                trend_down: "ğŸ“‰ Ğ¡Ğ¿Ğ°Ğ´",
                trend_flat: "â¡ï¸ Ğ¡Ñ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾",

                err_net: "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ",
                err_insufficient: "ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ğ½ÑƒĞ¶Ğ½Ğ¾ 12+ Ğ¼Ğ°Ñ‚Ñ‡ĞµĞ¹)",

                lbl_ref_kdr: "Ğ Ğ°Ğ½Ğ³ KD",
                lbl_ref_kr: "Ğ Ğ°Ğ½Ğ³ ÑƒĞ±Ğ¸Ğ¹ÑÑ‚Ğ²",
                lbl_ref_dr: "Ğ Ğ°Ğ½Ğ³ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸",
                lbl_ref_or: "Ğ Ğ°Ğ½Ğ³ Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ğ°",
                lbl_ref_wr: "Ğ’Ğ¸Ğ½Ñ€ĞµĞ¹Ñ‚ (ĞŸĞ¾ÑĞ». 12)",

                res_vic: "ĞŸĞĞ‘Ğ•Ğ”Ğ", res_def: "ĞŸĞĞ ĞĞ–Ğ•ĞĞ˜Ğ•", res_draw: "ĞĞ˜Ğ§Ğ¬Ğ¯",
                meta_map: "ĞšĞ°Ñ€Ñ‚Ğ°", meta_dur: "Ğ’Ñ€ĞµĞ¼Ñ", meta_win: "ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ",
                reasons: { 1: "Ğ”Ğ¾Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ", 2: "Ğ’Ñ€ĞµĞ¼Ñ/Ğ¡Ñ‡ĞµÑ‚", 3: "Ğ¡Ğ´Ğ°Ñ‡Ğ°" },

                medals: {
                    Destruction: "Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ÑƒĞ±Ğ¸Ğ¹Ñ†Ğ°",
                    Losses: "ĞŸÑƒÑˆĞµÑ‡Ğ½Ğ¾Ğµ Ğ¼ÑÑĞ¾",
                    DamageDealt: "Ğ¢ÑĞ¶ĞµĞ»Ğ°Ñ Ğ°Ñ€Ñ‚Ğ¸Ğ»Ğ»ĞµÑ€Ğ¸Ñ",
                    DamageReceived: "Ğ“ÑƒĞ±ĞºĞ° Ğ´Ğ»Ñ Ğ¿ÑƒĞ»ÑŒ",
                    SupplyPointsConsumed: "Ğ¢Ñ€Ğ°Ğ½Ğ¶Ğ¸Ñ€Ğ°",
                    SupplyPointsConsumedFromAllies: "Ğ¥Ğ°Ğ»ÑĞ²Ñ‰Ğ¸Ğº",
                    SupplyPointsConsumedByAllies: "ĞœĞµĞ´Ğ¸Ğº",
                    TotalSpawnedUnitScore: "Ğ’Ğ¾ĞµĞ½Ğ½Ğ°Ñ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ°",
                    TotalRefundedUnitScore: "ĞšĞ¾Ñ€Ğ¾Ğ»ÑŒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ¾Ğ²"
                },

                medal_descs: {
                    Destruction: "ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ ÑƒĞ½Ğ¸Ñ‡Ñ‚Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ñ… Ğ²Ñ€Ğ°Ğ³Ğ¾Ğ²",
                    Losses: "ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ½Ğ¸Ñ‚Ğ¾Ğ²",
                    DamageDealt: "ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¹ Ğ½Ğ°Ğ½ĞµÑĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ¸Ğ·Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑƒÑ€Ğ¾Ğ½",
                    DamageReceived: "ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ¸Ğ·Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑƒÑ€Ğ¾Ğ½",
                    SupplyPointsConsumed: "Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ¿Ğ°ÑĞ¾Ğ²",
                    SupplyPointsConsumedFromAllies: "Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµĞ³Ğ¾ Ğ²Ğ·ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ¿Ğ°ÑĞ¾Ğ² Ñƒ ÑĞ¾ÑĞ·Ğ½Ğ¸ĞºĞ¾Ğ²",
                    SupplyPointsConsumedByAllies: "Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµĞ³Ğ¾ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ¿Ğ°ÑĞ¾Ğ² ÑĞ¾ÑĞ·Ğ½Ğ¸ĞºĞ°Ğ¼",
                    TotalSpawnedUnitScore: "ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ½Ğ¸Ñ‚Ğ¾Ğ²",
                    TotalRefundedUnitScore: "ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ½Ğ¸Ñ‚Ğ¾Ğ²"
                },

                trend_desc: "Ğ¢Ñ€ĞµĞ½Ğ´ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¼Ğ°Ñ‚Ñ‡Ğ¸",
                elo_desc: "Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ ELO (ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸)",

                // New
                lbl_fav_units_title: "Ğ›ÑĞ±Ğ¸Ğ¼Ñ‹Ğµ ÑĞ½Ğ¸Ñ‚Ñ‹ (12 Ğ¼Ğ°Ñ‚Ñ‡ĞµĞ¹)",
                lbl_fav_dmg: "ĞœĞ°ĞºÑ. ÑƒÑ€Ğ¾Ğ½",
                lbl_fav_kill: "Ğ£Ğ±Ğ¸Ğ¹Ñ†Ğ°",
                lbl_fav_tank: "Ğ¢Ğ°Ğ½Ğº",

                unit_dmg_title: "ĞœĞ°ĞºÑ. ÑƒÑ€Ğ¾Ğ½",
                unit_kill_title: "Ğ£Ğ±Ğ¸Ğ¹Ñ†Ğ°",
                unit_tank_title: "Ğ¢Ğ°Ğ½Ğº",

                pd_dmg_dealt: "Ğ£Ñ€Ğ¾Ğ½", pd_dmg_taken: "ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾",
                pd_supply: "ĞŸÑ€Ğ¸Ğ¿Ğ°ÑÑ‹", pd_supply_ally: "ĞÑ‚ ÑĞ¾ÑĞ·.", pd_supply_give: "Ğ¡Ğ¾ÑĞ·Ğ½Ğ¸ĞºĞ°Ğ¼",
                pd_units: "Ğ®Ğ½Ğ¸Ñ‚Ñ‹"
            },
            ja: {
                title: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œå‹•åˆ†æ", 
                subtitle: "Broken Arrow æˆ¦ç¸¾åˆ†æ", 
                placeholder: "Steam64 ID ã¾ãŸã¯ ã‚²ãƒ¼ãƒ å†…ID...", 
                check: "åˆ†æé–‹å§‹", 
                loading: "åŒæœŸä¸­...", 
                maggot_index_title: "ç·åˆã‚¹ã‚³ã‚¢",
                god_range: "ç¥", 
                maggot_range: "åœ°é›·",
                history_title: "ç›´è¿‘12è©¦åˆã®è¨˜éŒ²",
                
                find_id_btn: "IDãŒä¸æ˜ãªå ´åˆã¯åå‰ã§æ¤œç´¢",
                find_match_btn: "ãƒãƒƒãƒIDã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢",
                
                modal_title: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDæ¤œç´¢", 
                modal_input_ph: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›...", 
                modal_btn_search: "æ¤œç´¢",
                modal_pname: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å", 
                modal_pid: "å†…éƒ¨ID", 
                modal_use_btn: "ã“ã®IDã§åˆ†æ",
                modal_status_search: "æ¤œç´¢ä¸­...", 
                modal_status_err: "ã‚¨ãƒ©ãƒ¼: ", 
                modal_status_none: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
                modal_status_found: "{n} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ",

                modal_match_title: "ãƒãƒƒãƒIDæ¤œç´¢",
                modal_match_input_ph: "ãƒãƒƒãƒIDã‚’å…¥åŠ› (ä¾‹: 184523)...",
                modal_match_btn_search: "æˆ¦ç¸¾å–å¾—",
                modal_match_loading: "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...",
                modal_match_err: "æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ",

                kill: "æ’ƒç ´", loss: "æå¤±", obj: "å é ˜",
                levels: ["ğŸ‘‘ ç¥æ§˜", "ğŸ¦ ã‚­ãƒ£ãƒªãƒ¼", "ğŸ˜ ä¸€èˆ¬å…µ", "ğŸ› å¾®åœ°é›·", "ğŸ’© è¶…åœ°é›·"],
                
                tag_killer: "âš”ï¸ ã‚­ãƒ«é‡è¦–", 
                tag_kd: "ğŸ“ˆ KDé‡è¦–", 
                tag_obj: "ğŸš© å é ˜é‡è¦–", 
                
                trend_up: "ğŸš€ èª¿å­ä¸Šæ˜‡ä¸­", 
                trend_down: "ğŸ“‰ èª¿å­ä½ä¸‹ä¸­", 
                trend_flat: "â¡ï¸ å®‰å®š", 
                
                err_net: "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ··é›‘ã€å¾Œã»ã©è©¦ã—ã¦ãã ã•ã„", 
                err_insufficient: "ãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼ˆ12è©¦åˆæœªæº€ï¼‰",
                
                lbl_ref_kdr: "KDãƒ©ãƒ³ã‚¯", 
                lbl_ref_kr: "æ’ƒç ´ãƒ©ãƒ³ã‚¯", 
                lbl_ref_dr: "ç”Ÿå­˜ãƒ©ãƒ³ã‚¯", 
                lbl_ref_or: "å é ˜ãƒ©ãƒ³ã‚¯", 
                lbl_ref_wr: "å‹ç‡ (ç›´è¿‘12æˆ¦)",
                
                res_vic: "å‹åˆ©", res_def: "æ•—åŒ—", res_draw: "å¼•åˆ†",
                meta_map: "ãƒãƒƒãƒ—", meta_dur: "æ™‚é–“", meta_win: "å‹è€…",
                reasons: { 1: "åœ§å€’", 2: "åˆ¤å®š", 3: "é™ä¼" },
                
                medals: {
                    Destruction: "æ’ƒç ´ç‹", 
                    Losses: "ç‰¹æ”»éšŠé•·",           
                    DamageDealt: "ç«åŠ›ç‹",       
                    DamageReceived: "ã‚¿ãƒ³ã‚¯ç‹",      
                    SupplyPointsConsumed: "æµªè²»å®¶",   
                    SupplyPointsConsumedFromAllies: "æ³¥æ£’çŒ«", 
                    SupplyPointsConsumedByAllies: "è¡›ç”Ÿå…µ",
                    TotalSpawnedUnitScore: "å‹•å“¡ç‹",
                    TotalRefundedUnitScore: "è¿”é‡‘ç‹" 
                },
                
                medal_descs: {
                    Destruction: "æ•µãƒ¦ãƒ‹ãƒƒãƒˆæ’ƒç ´ã‚¹ã‚³ã‚¢ãŒãƒãƒ¼ãƒ å†…æœ€å¤š", 
                    Losses: "è‡ªãƒ¦ãƒ‹ãƒƒãƒˆæå¤±ã‚¹ã‚³ã‚¢ãŒãƒãƒ¼ãƒ å†…æœ€å¤š (ã‚«ãƒ¢)", 
                    DamageDealt: "æ•µã¸ã®ç·ãƒ€ãƒ¡ãƒ¼ã‚¸é‡ãŒãƒãƒ¼ãƒ å†…æœ€å¤š", 
                    DamageReceived: "è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ç·é‡ãŒãƒãƒ¼ãƒ å†…æœ€å¤š",
                    SupplyPointsConsumed: "è£œçµ¦ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»é‡ãŒãƒãƒ¼ãƒ å†…æœ€å¤š", 
                    SupplyPointsConsumedFromAllies: "å‘³æ–¹ã®è£œçµ¦ç‰©è³‡ä½¿ç”¨é‡ãŒãƒãƒ¼ãƒ å†…æœ€å¤š", 
                    SupplyPointsConsumedByAllies: "å‘³æ–¹ã¸ã®è£œçµ¦æä¾›é‡ãŒãƒãƒ¼ãƒ å†…æœ€å¤š", 
                    TotalSpawnedUnitScore: "ãƒ¦ãƒ‹ãƒƒãƒˆé…å‚™ç·é¡ãŒãƒãƒ¼ãƒ å†…æœ€å¤š", 
                    TotalRefundedUnitScore: "ãƒ¦ãƒ‹ãƒƒãƒˆå£²å´ç·é¡ãŒãƒãƒ¼ãƒ å†…æœ€å¤š"
                },
                
                trend_desc: "ç›´è¿‘6è©¦åˆã¨ãã‚Œä»¥å‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ",
                elo_desc: "ç¾åœ¨ã®ELOãƒ¬ãƒ¼ãƒˆ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°)",

                // New
                lbl_fav_units_title: "æ„›ç”¨ãƒ¦ãƒ‹ãƒƒãƒˆ (ç›´è¿‘12æˆ¦ç´¯è¨ˆ)",
                lbl_fav_dmg: "ç«åŠ›æ‹…å½“ (ç·ã‚¹ã‚³ã‚¢)",
                lbl_fav_kill: "æ’ƒç ´æ‹…å½“ (ç·ã‚­ãƒ«)",
                lbl_fav_tank: "ã‚¿ãƒ³ã‚¯æ‹…å½“ (ç·è¢«å¼¾)",

                unit_dmg_title: "æœ€å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸",
                unit_kill_title: "æœ€å¤šã‚­ãƒ«",
                unit_tank_title: "æœ€å¤§è¢«å¼¾",

                pd_dmg_dealt: "ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸", pd_dmg_taken: "è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸",
                pd_supply: "è£œçµ¦ä½¿ç”¨", pd_supply_ally: "å‘³æ–¹è£œçµ¦ä½¿ç”¨", pd_supply_give: "å‘³æ–¹ã¸è£œçµ¦",
                pd_units: "ãƒ¦ãƒ‹ãƒƒãƒˆç·é¡"
            }
        };

        let currentLang = 'zh';
        const HISTORY_KEY = 'ba_maggot_v37_history';

        function setLang(l) {
            currentLang = l; 
            localStorage.setItem('ba_lang', l); 
            document.title = DICT[currentLang].title + " v3.34 - By Zola";
            updateUIStrings();
        }

        function updateUIStrings() {
            const t = DICT[currentLang];
            document.getElementById('lbl_title').innerText = t.title;
            document.getElementById('lbl_subtitle').innerText = t.subtitle;
            document.getElementById('steamInput').placeholder = t.placeholder;
            document.getElementById('btn_check').innerText = t.check;
            document.getElementById('lbl_maggot_index_title').innerText = t.maggot_index_title;
            document.getElementById('lbl_god_range').innerText = t.god_range;
            document.getElementById('lbl_maggot_range').innerText = t.maggot_range;
            document.getElementById('lbl_history_title').innerText = t.history_title;
            document.getElementById('lbl_find_id_btn').innerText = t.find_id_btn;
            document.getElementById('lbl_find_match_btn').innerText = t.find_match_btn;
            document.getElementById('lbl_ref_kdr').innerText = t.lbl_ref_kdr;
            document.getElementById('lbl_ref_kr').innerText = t.lbl_ref_kr;
            document.getElementById('lbl_ref_dr').innerText = t.lbl_ref_dr;
            document.getElementById('lbl_ref_or').innerText = t.lbl_ref_or;
            document.getElementById('lbl_ref_wr').innerText = t.lbl_ref_wr;
            
            document.getElementById('modal_title').innerText = t.modal_title;
            document.getElementById('modalSearchInput').placeholder = t.modal_input_ph;
            document.getElementById('modal_btn_search').innerText = t.modal_btn_search;
            document.getElementById('lbl_modal_pname').innerText = t.modal_pname;
            document.getElementById('lbl_modal_pid').innerText = t.modal_pid;
            document.getElementById('btn_use_id').innerText = t.modal_use_btn;

            document.getElementById('modal_match_title').innerText = t.modal_match_title;
            document.getElementById('matchIdInput').placeholder = t.modal_match_input_ph;
            document.getElementById('modal_match_btn_search').innerText = t.modal_match_btn_search;

            // Player Detail Labels
            document.getElementById('lbl_pd_kill').innerText = t.kill;
            document.getElementById('lbl_pd_loss').innerText = t.loss;
            document.getElementById('lbl_pd_obj').innerText = t.obj;
            document.getElementById('lbl_pd_dmg_dealt').innerText = t.pd_dmg_dealt;
            document.getElementById('lbl_pd_dmg_taken').innerText = t.pd_dmg_taken;
            document.getElementById('lbl_pd_supply').innerText = t.pd_supply;
            document.getElementById('lbl_pd_supply_ally').innerText = t.pd_supply_ally;
            document.getElementById('lbl_pd_supply_give').innerText = t.pd_supply_give;
            document.getElementById('lbl_pd_units').innerText = t.pd_units;
            document.getElementById('lbl_pd_top_dmg').innerText = t.unit_dmg_title;
            document.getElementById('lbl_pd_top_kill').innerText = t.unit_kill_title;
            document.getElementById('lbl_pd_top_tank').innerText = t.unit_tank_title;

            const btnBase = "px-3 py-1 md:px-5 md:py-1.5 text-xs rounded-lg transition font-bold";
            const btnActive = "bg-cyan-600 text-white shadow-lg shadow-cyan-900/40";
            const btnInactive = "text-slate-400 hover:text-white";

            document.getElementById('btn_lang_zh').className = `${btnBase} ${currentLang==='zh'?btnActive:btnInactive}`;
            document.getElementById('btn_lang_en').className = `${btnBase} ${currentLang==='en'?btnActive:btnInactive}`;
            document.getElementById('btn_lang_ru').className = `${btnBase} ${currentLang==='ru'?btnActive:btnInactive}`;
            document.getElementById('btn_lang_ja').className = `${btnBase} ${currentLang==='ja'?btnActive:btnInactive}`;
        }

        async function robustFetch(url, attempt = 0) {
            const proxy = CONFIG.PROXIES[attempt % CONFIG.PROXIES.length];
            try {
                const fetchUrl = proxy.url(url);
                const r = await fetch(fetchUrl);
                if(!r.ok) throw new Error(`HTTP_${r.status}`);
                const d = await r.json();
                
                // AllOrigins / Codetabs formatting
                if (d.contents) {
                    return typeof d.contents === 'string' ? JSON.parse(d.contents) : d.contents;
                }
                return d;
            } catch (e) {
                if (attempt < 4) return robustFetch(url, attempt + 1);
                throw e;
            }
        }

        window.onload = () => {
            const savedLang = localStorage.getItem('ba_lang');
            setLang(savedLang || 'zh'); // é»˜è®¤ä¸­æ–‡
            renderHistory();
            const urlId = new URLSearchParams(window.location.search).get('steamId');
            if(urlId) { document.getElementById('steamInput').value=urlId; handleCheck(); }
        };

        function renderHistory() {
            const h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const container = document.getElementById('historyContainer');
            container.innerHTML = h.map(x => `
                <div class="history-chip">
                    <span class="font-bold" onclick="useHistory('${x.id}')">${escapeHtml(x.name)}</span>
                    <span class="history-del cursor-pointer" onclick="event.stopPropagation(); removeHistory('${x.id}')">Ã—</span>
                </div>
            `).join('');
        }
        function useHistory(id) { document.getElementById('steamInput').value = id; handleCheck(); }
        function removeHistory(id) {
            let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            localStorage.setItem(HISTORY_KEY, JSON.stringify(h.filter(x => x.id !== id)));
            renderHistory();
        }

        function updateProgress(percent, status, detail) {
            document.getElementById('loadPercent').innerText = percent + '%';
            document.getElementById('loadProgressFill').style.width = percent + '%';
            document.getElementById('loadStatus').innerText = status;
            document.getElementById('loadDetail').innerText = detail;
        }

        // --- Load Global Unit Library with Caching (24 Hours) ---
        async function ensureGlobalUnitList() {
            if (IS_UNIT_CACHE_LOADED) return;
            
            const now = Date.now();
            const cachedData = localStorage.getItem(UNIT_CACHE_KEY);
            const cachedTime = localStorage.getItem(UNIT_CACHE_TS_KEY);
            const oneDay = 24 * 60 * 60 * 1000;

            // 1. å°è¯•ä»ç¼“å­˜è¯»å–
            if (cachedData && cachedTime && (now - parseInt(cachedTime) < oneDay)) {
                try {
                    const list = JSON.parse(cachedData);
                    processUnitList(list);
                    console.log('Unit Library loaded from Cache');
                    return;
                } catch (e) {
                    console.warn('Cache corrupted, fetching fresh data');
                }
            }

            // 2. ç¼“å­˜å¤±æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œç½‘ç»œè¯·æ±‚
            try {
                // Direct fetch (CORS enabled)
                const resp = await fetch('https://batrace.aoeiaol.top/api/v1/Units');
                if (!resp.ok) throw new Error('Unit API Failed');
                const list = await resp.json();
                
                // æ›´æ–°ç¼“å­˜
                localStorage.setItem(UNIT_CACHE_KEY, JSON.stringify(list));
                localStorage.setItem(UNIT_CACHE_TS_KEY, now.toString());
                
                processUnitList(list);
                console.log('Unit Library loaded from API');
            } catch (e) {
                console.warn('Failed to load unit library:', e);
                // 3. ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ—§ç¼“å­˜ï¼ˆå³ä½¿è¿‡æœŸï¼‰
                if (cachedData) {
                    try {
                        const list = JSON.parse(cachedData);
                        processUnitList(list);
                        console.log('Unit Library loaded from STALE Cache');
                    } catch(ex) {}
                }
            }
        }

        function processUnitList(list) {
            if (Array.isArray(list)) {
                list.forEach(u => {
                    const id = u.Id || u.id;
                    const name = u.Name || u.name;
                    if (id && name) {
                        UNIT_NAME_CACHE[id] = name;
                    }
                });
                IS_UNIT_CACHE_LOADED = true;
            }
        }

        function getUnitDisplayName(id) {
            return UNIT_NAME_CACHE[id] || `Unit ${id}`;
        }

        async function handleCheck() {
            const input = document.getElementById('steamInput').value.trim();
            if(!input) return;

            if (typeof gtag === 'function') {
                gtag('event', 'search_player', {
                    'search_term': input
                });
            }

            const t = DICT[currentLang];
            
            document.getElementById('errorArea').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultPanel').classList.add('hidden');
            
            document.getElementById('unitStickerContainer').innerHTML = '';

            updateProgress(0, t.loading, "Initializing...");

            // æå‰å°è¯•åŠ è½½å•ä½åº“ï¼Œä½†ä¸é˜»å¡ä¸»æµç¨‹å¤ªä¹…
            ensureGlobalUnitList();

            try {
                let uid = input;
                let userData = null;
                if (input.length > 10 || isNaN(input)) {
                    updateProgress(5, "Resolving...", "Checking Identity...");
                    userData = await robustFetch(`https://www.barmory.net/stb/commander/${input}/steam`);
                    uid = String(userData.id);
                }

                updateProgress(10, "Scanning...", "Pulling Matches...");
                const timeStr = new Date().toISOString().split('T')[0] + '_' + new Date().getHours().toString().padStart(2,'0');
                const matchList = await robustFetch(`https://www.barmory.net/stb/commander/${uid}/matches?time=${timeStr}`);
                
                const validMatches = [];
                for(let i=0; i < matchList.length && validMatches.length < CONFIG.MATCH_GOAL; i++) {
                    const mId = matchList[i];
                    try {
                        const detail = await robustFetch(`https://www.barmory.net/stb/match/${mId}`);
                        const players = Object.values(detail.Data);
                        const hasEloChange = players.some(p => Math.abs(p.NewRating - p.OldRating) > 0.01);
                        if(players.length >= CONFIG.MIN_PLAYERS && hasEloChange) {
                            validMatches.push({ id: mId, data: detail });
                            const prg = Math.round((validMatches.length / CONFIG.MATCH_GOAL) * 100);
                            updateProgress(prg, `Syncing (${validMatches.length}/12)`, `Match ${mId} OK`);
                        }
                    } catch(e) { console.error(`Match ${mId} Failed`, e); }
                    await new Promise(r => setTimeout(r, 600)); 
                }

                if(validMatches.length < CONFIG.MATCH_GOAL) throw new Error(t.err_insufficient);
                
                const finalMe = validMatches[0].data.Data[uid];
                saveHistory(uid, finalMe?.Name);
                
                document.getElementById('userNameDisplay').innerText = `${finalMe?.Name || 'Unknown'} ${finalMe?.Level ? '(Lv.' + finalMe.Level + ')' : ''}`;
                document.getElementById('calcTimeDisplay').innerText = `Calculated: ${new Date().toLocaleString()}`;

                // æ¸²æŸ“ä¸»ç•Œé¢
                processFinalData(uid, validMatches);

            } catch (e) {
                document.getElementById('errorArea').classList.remove('hidden');
                document.getElementById('errorMsg').innerText = e.message;
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function formatDuration(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}m ${s}s`;
        }

        function formatMatchTime(ts) {
            const d = new Date(ts * 1000);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        // ============================================
        // [New] ç´¯è®¡çˆ±ç”¨å•ä½ - å¼‚æ­¥è´´çº¸é€»è¾‘
        // ============================================
        function calculateFavoriteUnits(matches, myUid) {
            const unitStats = {};

            matches.forEach(m => {
                const myData = m.data.Data[myUid];
                if (!myData || !myData.UnitData) return;

                Object.values(myData.UnitData).forEach(unit => {
                    const typeId = unit.Id; 
                    if (!typeId) return;

                    if (!unitStats[typeId]) {
                        unitStats[typeId] = {
                            id: typeId,
                            damageDealt: 0,
                            kills: 0,
                            damageReceived: 0
                        };
                    }

                    unitStats[typeId].damageDealt += (unit.TotalDamageDealt || 0);
                    unitStats[typeId].kills += (unit.KilledCount || 0);
                    unitStats[typeId].damageReceived += (unit.TotalDamageReceived || 0);
                });
            });

            const unitsArr = Object.values(unitStats);
            if (unitsArr.length === 0) return null;

            const topDmg = [...unitsArr].sort((a,b) => b.damageDealt - a.damageDealt)[0];
            const topKill = [...unitsArr].sort((a,b) => b.kills - a.kills)[0];
            const topTank = [...unitsArr].sort((a,b) => b.damageReceived - a.damageReceived)[0];

            return { topDmg, topKill, topTank };
        }

        async function fetchAndShowUnitStickers(favUnits) {
            // ç¡®ä¿å­—å…¸åŠ è½½ï¼ˆå¦‚æœè¿˜æ²¡åŠ è½½å®Œçš„è¯ï¼‰
            await ensureGlobalUnitList();

            const container = document.getElementById('unitStickerContainer');
            if(!container) return;
            // ============================================
            // [FIX] ä¿®å¤ï¼šåœ¨è¿™é‡Œæ·»åŠ æ¸…ç©ºé€»è¾‘ï¼Œé˜²æ­¢é‡å¤è¿½åŠ 
            container.innerHTML = ''; 
            // ============================================
            const items = [
                { type: 'dmg', unit: favUnits.topDmg, icon: 'âš¡', labelPrefix: { zh: 'è¾“å‡º', en: 'Dmg', ja: 'ç«åŠ›', ru: 'Dmg' } },
                { type: 'kill', unit: favUnits.topKill, icon: 'ğŸ”«', labelPrefix: { zh: 'å‡»æ€', en: 'Kill', ja: 'æ’ƒç ´', ru: 'Kill' } },
                { type: 'tank', unit: favUnits.topTank, icon: 'ğŸ›¡ï¸', labelPrefix: { zh: 'æŠ—ä¼¤', en: 'Tank', ja: 'è€ä¹…', ru: 'Tank' } }
            ];

            for (const item of items) {
                if (!item.unit || item.unit.id <= 0) continue;

                let name = getUnitDisplayName(item.unit.id);
                
                // åªæœ‰å½“æœ‰å•ä½åæ—¶æ‰æ˜¾ç¤º
                if (name) {
                    const el = document.createElement('div');
                    let colorClass = "bg-slate-600/20 border-slate-500/50 text-slate-300";
                    if(item.type === 'dmg') colorClass = "bg-orange-600/20 border-orange-500/50 text-orange-300";
                    if(item.type === 'kill') colorClass = "bg-red-600/20 border-red-500/50 text-red-300";
                    if(item.type === 'tank') colorClass = "bg-blue-600/20 border-blue-500/50 text-blue-300";

                    el.className = `tag-sticker tag-sticker-left ${colorClass} flex items-center gap-2 cursor-help`;
                    
                    let valStr = '';
                    if(item.type === 'dmg') valStr = Math.round(item.unit.damageDealt).toLocaleString();
                    if(item.type === 'kill') valStr = item.unit.kills;
                    if(item.type === 'tank') valStr = Math.round(item.unit.damageReceived).toLocaleString();
                    el.title = `${item.labelPrefix[currentLang] || item.labelPrefix.en}: ${valStr}`;

                    el.innerHTML = `<span class="text-lg">${item.icon}</span><span>${name}</span>`;
                    container.appendChild(el);
                    
                    await new Promise(r => setTimeout(r, 100));
                }
            }
        }

        function processFinalData(myUid, matches) {
            let kRankSum = 0, oRankSum = 0, kdRankSum = 0, lossRankSum = 0, wins = 0;
            const medalCounts = {};

            const stats = matches.map(m => {
                const data = m.data.Data;
                const meta = m.data; 

                let t1DeltaSum = 0, t1Count = 0;
                let t0DeltaSum = 0, t0Count = 0;

                Object.values(data).forEach(p => {
                    if (p.Name) { 
                        const d = (p.NewRating || 0) - (p.OldRating || 0);
                        if (p.TeamId === 1) { 
                            t1DeltaSum += d; t1Count++; 
                        } else { 
                            t0DeltaSum += d; t0Count++; 
                        }
                    }
                });
                
                const avgT1 = t1Count > 0 ? t1DeltaSum / t1Count : 0;
                const avgT0 = t0Count > 0 ? t0DeltaSum / t0Count : 0;

                const players = Object.entries(data).map(([key, val]) => {
                    if (!val.Id) val.Id = key;

                    if (val.Name) {
                        val.TeamId = (val.TeamId === 1) ? 1 : 0;
                    } else {
                        val.Name = "Unknown";
                        const myDelta = (val.NewRating || 0) - (val.OldRating || 0);
                        const distT1 = Math.abs(myDelta - avgT1);
                        const distT0 = Math.abs(myDelta - avgT0);
                        if (t1Count === 0 && t0Count === 0) {
                             val.TeamId = myDelta >= 0 ? 1 : 0;
                        } else {
                             val.TeamId = distT1 < distT0 ? 1 : 0;
                        }
                    }
                    return val;
                });

                if (meta.WinnerTeam === undefined) {
                    let team0EloDelta = 0;
                    let team1EloDelta = 0;
                    players.forEach(p => {
                        if (p.NewRating !== undefined && p.OldRating !== undefined) {
                            const delta = p.NewRating - p.OldRating;
                            if (p.TeamId === 0) team0EloDelta += delta;
                            if (p.TeamId === 1) team1EloDelta += delta;
                        }
                    });
                    meta.WinnerTeam = team0EloDelta > team1EloDelta ? 0 : 1;
                }

                const myP = players.find(p => String(p.Id) === String(myUid));
                const myTeamId = myP ? myP.TeamId : (meta.WinnerTeam === 0 ? 1 : 0); 
                
                const isDraw = meta.WinnerTeam === 101;
                const isWin = !isDraw && (myTeamId === meta.WinnerTeam);
                
                if(isWin) wins++; 

                const maxK = Math.max(...players.map(p => p.DestructionScore || 0), 1);
                const maxL = Math.max(...players.map(p => p.LossesScore || 0), 1);
                const maxO = Math.max(...players.map(p => p.ObjectivesCaptured || 0), 1);
                
                const mapPlayer = (p) => {
                    const k = p.DestructionScore || 0, l = p.LossesScore || 0;
                    
                    // --- å•å±€å†…å•ä½ç»Ÿè®¡ (èšåˆç‰ˆ) ---
                    let topD = {id:0, v:-1}, topK = {id:0, v:-1}, topT = {id:0, v:-1};
                    
                    if (p.UnitData) {
                        const unitAgg = {};
                        Object.values(p.UnitData).forEach(u => {
                            if (!u.Id) return;
                            if (!unitAgg[u.Id]) unitAgg[u.Id] = { d: 0, k: 0, t: 0 };
                            // ç´¯åŠ åŒIDå•ä½çš„æ•°æ®
                            unitAgg[u.Id].d += (u.TotalDamageDealt || 0);
                            unitAgg[u.Id].k += (u.KilledCount || 0);
                            unitAgg[u.Id].t += (u.TotalDamageReceived || 0);
                        });

                        Object.entries(unitAgg).forEach(([uid, stats]) => {
                            if (stats.d > topD.v) topD = {id: uid, v: stats.d};
                            if (stats.k > topK.v) topK = {id: uid, v: stats.k};
                            if (stats.t > topT.v) topT = {id: uid, v: stats.t};
                        });
                    }

                    return {
                        id: p.Id, name: p.Name, elo: p.NewRating ? p.NewRating.toFixed(0) : "N/A",
                        gain: p.NewRating && p.OldRating ? (p.NewRating - p.OldRating).toFixed(1) : "0.0",
                        kPct: (k / maxK) * 100, lPct: (l / maxL) * 100, oPct: ((p.ObjectivesCaptured || 0) / maxO) * 100,
                        isMe: String(p.Id) === String(myUid),
                        score: (k - l) / 1000 + (p.ObjectivesCaptured || 0),
                        kScore: k, lScore: l, oScore: p.ObjectivesCaptured || 0, kd: k / (l || 1),
                        rawData: p,
                        medals: [],
                        favUnits: { d: topD, k: topK, t: topT } // Store fav units
                    };
                };

                const ally = players.filter(p => p.TeamId === myTeamId).map(mapPlayer).sort((a,b)=>b.score - a.score);
                const enemy = players.filter(p => p.TeamId !== myTeamId).map(mapPlayer).sort((a,b)=>b.score - a.score);

                const assignMedals = (teamPlayers) => {
                    MEDAL_CONFIG.forEach(def => {
                        const maxVal = Math.max(...teamPlayers.map(p => p.rawData[def.key] || 0));
                        if (maxVal > 0) { 
                            teamPlayers.forEach(p => {
                                if ((p.rawData[def.key] || 0) === maxVal) {
                                    p.medals.push({ ...def, val: maxVal });
                                }
                            });
                        }
                    });
                };
                assignMedals(ally);
                assignMedals(enemy);

                const myP_Mapped = ally.find(p => p.isMe);
                if(myP_Mapped && myP_Mapped.medals) {
                    myP_Mapped.medals.forEach(m => {
                        medalCounts[m.key] = (medalCounts[m.key] || 0) + 1;
                    });
                }

                const calcR = (list, fn) => { 
                    const r = [...list].sort(fn).findIndex(p=>p.isMe) + 1; 
                    return r === 0 ? 5 : r; 
                };

                kRankSum += calcR(ally, (a,b)=>b.kScore - a.kScore);
                oRankSum += calcR(ally, (a,b)=>b.oScore - a.oScore);
                kdRankSum += calcR(ally, (a,b)=>b.kd - a.kd);
                lossRankSum += calcR(ally, (a,b)=>a.lScore - b.lScore);

                let currentMatchRank = ally.findIndex(p => p.isMe) + 1;
                if (currentMatchRank === 0) currentMatchRank = 5;

                return { 
                    id: m.id, 
                    myRank: currentMatchRank, 
                    ally, enemy,
                    isWin: isWin,
                    isDraw: isDraw, 
                    endReason: meta.EndMatchReason,
                    endTime: meta.EndTime,
                    mapId: meta.MapId,
                    duration: meta.TotalPlayTimeInSec,
                    winnerTeam: meta.WinnerTeam
                };
            });

            // Store stats globally so click handlers can access them
            CURRENT_MATCH_STATS = stats;

            const topMedals = Object.entries(medalCounts)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 2)
                .map(x => x[0]);

            renderResults(stats, kRankSum/12, kdRankSum/12, oRankSum/12, lossRankSum/12, wins, topMedals);

            const favUnits = calculateFavoriteUnits(matches, myUid);
            if (favUnits) {
                fetchAndShowUnitStickers(favUnits);
            }
        }

        function renderResults(stats, avgKR, avgKDR, avgOR, avgDR, wins, topMedals) {
            const t = DICT[currentLang];
            document.getElementById('resultPanel').classList.remove('hidden');
            
            const avgRank = stats.reduce((a,b) => a + b.myRank, 0) / stats.length; 
            const normalizedRank = (avgRank - 1) / 4; 
            const sCurveValue = (1 - Math.cos(normalizedRank * Math.PI)) / 2; 
            const maggotIndex = 1 + (sCurveValue * 9); 

            const display = document.getElementById('maggotScoreDisplay');
            display.innerText = maggotIndex.toFixed(1);
            display.style.color = maggotIndex <= 3.5 ? '#4ade80' : (maggotIndex <= 7 ? '#facc15' : '#f87171');
            document.getElementById('maggotLabel').innerText = t.levels[maggotIndex <= 2 ? 0 : (maggotIndex <= 4 ? 1 : (maggotIndex <= 6 ? 2 : (maggotIndex <= 8 ? 3 : 4)))];
            document.getElementById('meterIndicator').style.left = `${((maggotIndex-1)/9)*100}%`;

            document.getElementById('ref_avgKDR').innerText = `#${avgKDR.toFixed(1)}`;
            document.getElementById('ref_avgKR').innerText = `#${avgKR.toFixed(1)}`;
            document.getElementById('ref_avgDR').innerText = `#${avgDR.toFixed(1)}`;
            document.getElementById('ref_avgOR').innerText = `#${avgOR.toFixed(1)}`;
            document.getElementById('ref_WR').innerText = Math.round((wins / stats.length) * 100) + '%';

            // --- æ¸²æŸ“å¾½ç« è´´çº¸ (å³ä¾§) ---
            const container = document.querySelector('.tag-sticker-container');
            container.innerHTML = ''; 

            const colorStyles = {
                red:    "bg-red-600/20 border-red-500/50 text-red-300",
                orange: "bg-orange-600/20 border-orange-500/50 text-orange-300",
                amber:  "bg-amber-600/20 border-amber-500/50 text-amber-300",
                yellow: "bg-yellow-600/20 border-yellow-500/50 text-yellow-300",
                lime:   "bg-lime-600/20 border-lime-500/50 text-lime-300",
                green:  "bg-green-600/20 border-green-500/50 text-green-300",
                emerald:"bg-emerald-600/20 border-emerald-500/50 text-emerald-300",
                teal:   "bg-teal-600/20 border-teal-500/50 text-teal-300",
                cyan:   "bg-cyan-600/20 border-cyan-500/50 text-cyan-300",
                sky:    "bg-sky-600/20 border-sky-500/50 text-sky-300",
                blue:   "bg-blue-600/20 border-blue-500/50 text-blue-300",
                indigo: "bg-indigo-600/20 border-indigo-500/50 text-indigo-300",
                violet: "bg-violet-600/20 border-violet-500/50 text-violet-300",
                purple: "bg-purple-600/20 border-purple-500/50 text-purple-300",
                fuchsia:"bg-fuchsia-600/20 border-fuchsia-500/50 text-fuchsia-300",
                pink:   "bg-pink-600/20 border-pink-500/50 text-pink-300",
                rose:   "bg-rose-600/20 border-rose-500/50 text-rose-300",
                slate:  "bg-slate-600/20 border-slate-500/50 text-slate-300",
                gray:   "bg-gray-600/20 border-gray-500/50 text-gray-300",
                zinc:   "bg-zinc-600/20 border-zinc-500/50 text-zinc-300",
                stone:  "bg-stone-600/20 border-stone-500/50 text-stone-300",
            };

            topMedals.forEach(key => {
                const conf = MEDAL_CONFIG.find(c => c.key === key);
                if(!conf) return;
                
                const dict = DICT[currentLang];
                const name = dict.medals[key] || key;
                const desc = dict.medal_descs[key] || name;

                const colorBase = conf.color.replace('text-', '').replace('-400', '');
                const styleClass = colorStyles[colorBase] || colorStyles['gray'];
                
                const el = document.createElement('div');
                el.title = desc; 
                el.className = `tag-sticker ${styleClass} flex items-center gap-2 cursor-help`; 
                el.innerHTML = `<span class="text-lg">${conf.icon}</span><span>${name}</span>`;
                container.appendChild(el);
            });

            // Trend
            const recentAvg = stats.slice(0,3).reduce((a,b)=>a+b.myRank,0)/3;
            const oldAvg = stats.slice(3).reduce((a,b)=>a+b.myRank,0)/9;
            const trendText = recentAvg < oldAvg - 0.4 ? t.trend_up : (recentAvg > oldAvg + 0.4 ? t.trend_down : t.trend_flat);
            const trendEl = document.createElement('div');
            trendEl.title = t.trend_desc;
            trendEl.className = "tag-sticker bg-slate-600/20 border-slate-500/50 text-slate-300 cursor-help";
            trendEl.innerText = trendText;
            container.appendChild(trendEl);

            // Elo
            if (stats.length > 0) {
                const currentMe = stats[0].ally.find(p => p.isMe);
                if (currentMe) {
                    const eloEl = document.createElement('div');
                    eloEl.title = t.elo_desc;
                    eloEl.className = "tag-sticker bg-violet-600/20 border-violet-500/50 text-violet-300 font-mono cursor-help";
                    eloEl.innerHTML = `ELO ${currentMe.elo}`;
                    container.appendChild(eloEl);
                }
            }

            document.getElementById('matchesContainer').innerHTML = stats.map(m => {
                const reasonText = t.reasons[m.endReason] || t.reasons[1];
                const timeText = formatMatchTime(m.endTime);
                const durText = formatDuration(m.duration);
                let resultBadgeColor, resultText;
                if (m.isDraw) {
                    resultBadgeColor = 'bg-slate-600/30 text-slate-300 border border-slate-500/30';
                    resultText = t.res_draw;
                } else {
                    resultBadgeColor = m.isWin ? 'bg-cyan-600/20 text-cyan-400' : 'bg-red-600/20 text-red-400';
                    resultText = m.isWin ? t.res_vic : t.res_def;
                }

                return `
                <div class="glass-panel rounded-[2rem] md:rounded-[3rem] overflow-hidden border-white/10 shadow-2xl">
                    <div class="bg-white/5 px-4 py-3 md:px-8 md:py-4 flex flex-col md:flex-row justify-between items-start md:items-center text-[10px] md:text-xs font-bold font-mono text-slate-400 gap-2 md:gap-0">
                        <div class="flex flex-wrap items-center gap-2 md:gap-4 leading-relaxed">
                            <span class="whitespace-nowrap">ID: ${m.id}</span>
                            <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                            <span>${timeText}</span>
                            <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                            <span>${t.meta_map} ${m.mapId}</span>
                            <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                            <span>${durText}</span>
                            <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                            <span class="whitespace-nowrap">${reasonText}</span>
                        </div>
                        <span class="px-3 py-1 md:px-4 md:py-1 ${resultBadgeColor} rounded-lg font-black uppercase tracking-widest flex items-center gap-2 self-end md:self-auto">
                            <span>Rank #${m.myRank}</span>
                            <span class="opacity-50">/</span>
                            <span>${resultText}</span>
                        </span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-px bg-white/10">
                        <div class="bg-[#0f172a] p-2 md:p-4">${renderTeam(m.ally, t, m.id)}</div>
                        <div class="bg-[#0f172a] p-2 md:p-4">${renderTeam(m.enemy, t, m.id)}</div>
                    </div>
                </div>
            `}).join('');
        }

        function renderTeam(players, t, matchId) {
            return players.map(p => {
                const hoverDetail = `${t.kill}: ${p.kScore.toLocaleString()} | ${t.loss}: ${p.lScore.toLocaleString()} | ${t.obj}: ${p.oScore}`;
                const medalsHtml = p.medals.length > 0 ? 
                    `<div class="flex flex-wrap gap-1 mt-1.5">${p.medals.map(m => {
                        const mName = t.medals[m.key] || m.key;
                        return `<div class="medal-badge group" title="${mName}: ${Math.round(m.val).toLocaleString()}">
                                <span class="text-[10px] md:text-[12px] filter drop-shadow-md select-none leading-none">${m.icon}</span>
                                <span class="text-[10px] font-bold ${m.color} opacity-90 leading-none whitespace-nowrap">${mName}</span>
                            </div>`;
                    }).join('')}</div>` : '';

                // --- æ¸²æŸ“çˆ±ç”¨å•ä½å›¾æ ‡ (é‡æ„ä¸ºç›´æ˜¾ä¸‰æ’) ---
                let favHtml = '';
                if (p.favUnits) {
                    const uD = p.favUnits.d.id > 0 ? getUnitDisplayName(p.favUnits.d.id) : '';
                    const uK = p.favUnits.k.id > 0 ? getUnitDisplayName(p.favUnits.k.id) : '';
                    const uT = p.favUnits.t.id > 0 ? getUnitDisplayName(p.favUnits.t.id) : '';
                    
                    const renderTag = (name, val, colorClass, textClass) => {
                        if (!name) return '';
                        // æ‰‹æœºç”µè„‘ç»Ÿä¸€æ˜¾ç¤º: åå­—+æ•°å€¼ (å»æ‰äº†å›¾æ ‡å‚æ•°)
                        return `<div class="match-unit-tag ${textClass} ${colorClass}">
                            <span class="truncate opacity-90 flex-1">${name}</span>
                            <span class="ml-1 opacity-70">${val}</span>
                        </div>`;
                    };

                    const tagD = renderTag(uD, Math.round(p.favUnits.d.v).toLocaleString(), 'border-orange-500/30 bg-orange-900/20', 'text-orange-200');
                    const tagK = renderTag(uK, p.favUnits.k.v, 'border-red-500/30 bg-red-900/20', 'text-red-200');
                    const tagT = renderTag(uT, Math.round(p.favUnits.t.v).toLocaleString(), 'border-blue-500/30 bg-blue-900/20', 'text-blue-200');
                    
                    if (tagD || tagK || tagT) {
                        favHtml = `<div class="flex flex-col gap-0.5 ml-2 w-24 md:w-32 flex-shrink-0 border-l border-white/10 pl-1 justify-center h-full">
                            ${tagD}${tagK}${tagT}
                        </div>`;
                    }
                }

                return `
                <div class="teammate-row flex items-center p-2 md:p-3 rounded-xl md:rounded-2xl ${p.isMe?'is-me':''}" title="${hoverDetail}" onclick="openPlayerDetail('${matchId}', '${p.id}')">
                    <div class="flex-1 min-w-0 pr-2 md:pr-4 flex flex-col justify-center relative">
                        <div class="flex justify-between items-start w-full">
                            <div class="text-xs md:text-sm font-black text-slate-100 truncate mb-0.5 mr-1">${escapeHtml(p.name)}</div>
                            <div class="text-right font-mono flex-shrink-0 flex flex-col items-end leading-none">
                                <div class="text-[10px] md:text-[11px] font-black ${parseFloat(p.gain)>=0?'text-green-500':'text-red-500'}">${parseFloat(p.gain)>=0?'+':''}${p.gain}</div>
                                <div class="text-[9px] md:text-[10px] font-bold text-slate-500">ELO ${p.elo}</div>
                            </div>
                        </div>
                        ${medalsHtml}
                        <div class="id-link mt-1" onclick="event.stopPropagation(); inspect('${p.id}')">${p.id}</div>
                    </div>
                    
                    <div class="w-16 md:w-28 space-y-1 flex-shrink-0">
                        <div class="flex items-center gap-1"><div class="bar-container"><div class="bar-kill" style="width:${p.kPct}%"></div></div></div>
                        <div class="flex items-center gap-1"><div class="bar-container"><div class="bar-loss" style="width:${p.lPct}%"></div></div></div>
                        <div class="flex items-center gap-1"><div class="bar-container"><div class="bar-obj" style="width:${p.oPct}%"></div></div></div>
                    </div>

                    ${favHtml}
                </div>
            `}).join('');
        }

        // --- Player Detail Modal Logic ---
        function openPlayerDetail(matchId, playerId) {
            const match = CURRENT_MATCH_STATS.find(m => String(m.id) === String(matchId));
            if(!match) return;

            // Search in ally and enemy
            let player = match.ally.find(p => String(p.id) === String(playerId));
            if (!player) player = match.enemy.find(p => String(p.id) === String(playerId));
            if (!player) return;

            const t = DICT[currentLang];
            const raw = player.rawData;

            document.getElementById('pd_name').innerText = player.name || 'Unknown';
            document.getElementById('pd_id').innerText = `ID: ${player.id}`;
            document.getElementById('pd_elo').innerText = `ELO ${player.elo} (${parseFloat(player.gain)>=0?'+':''}${player.gain})`;
            document.getElementById('pd_elo').className = parseFloat(player.gain) >= 0 ? "text-green-400 font-mono" : "text-red-400 font-mono";

            document.getElementById('pd_kill').innerText = Math.round(player.kScore).toLocaleString();
            document.getElementById('pd_loss').innerText = Math.round(player.lScore).toLocaleString();
            document.getElementById('pd_obj').innerText = Math.round(player.oScore).toLocaleString();
            document.getElementById('pd_kd').innerText = player.kd.toFixed(2);

            // Detailed Stats
            document.getElementById('pd_dmg_dealt').innerText = Math.round(raw.DamageDealt || 0).toLocaleString();
            document.getElementById('pd_dmg_taken').innerText = Math.round(raw.DamageReceived || 0).toLocaleString();
            document.getElementById('pd_supply').innerText = Math.round(raw.SupplyPointsConsumed || 0).toLocaleString();
            document.getElementById('pd_supply_ally').innerText = Math.round(raw.SupplyPointsConsumedFromAllies || 0).toLocaleString();
            document.getElementById('pd_supply_give').innerText = Math.round(raw.SupplyPointsConsumedByAllies || 0).toLocaleString();
            document.getElementById('pd_units').innerText = Math.round(raw.TotalSpawnedUnitScore || 0).toLocaleString();

            // Top Units
            const setTopUnit = (prefix, unitObj) => {
                const name = unitObj && unitObj.id > 0 ? getUnitDisplayName(unitObj.id) : '-';
                const val = unitObj && unitObj.v > -1 ? Math.round(unitObj.v).toLocaleString() : '0';
                document.getElementById(`${prefix}_name`).innerText = name;
                document.getElementById(`${prefix}_val`).innerText = val;
            };

            setTopUnit('pd_top_dmg', player.favUnits.d);
            setTopUnit('pd_top_kill', player.favUnits.k);
            setTopUnit('pd_top_tank', player.favUnits.t);

            document.getElementById('playerDetailModal').classList.remove('hidden');
        }

        function closePlayerDetailModal() {
            document.getElementById('playerDetailModal').classList.add('hidden');
        }

        function saveHistory(id, name) {
            let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            h = h.filter(x => x.id !== id);
            h.unshift({ id, name: name || id });
            localStorage.setItem(HISTORY_KEY, JSON.stringify(h.slice(0, 10)));
            renderHistory();
        }
        function inspect(id) { 
            const newUrl = window.location.origin + window.location.pathname + '?steamId=' + id;
            window.open(newUrl, '_blank'); 
        }
        function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        function openSearchModal() {
            document.getElementById('idSearchModal').classList.remove('hidden');
            document.getElementById('modalSearchInput').focus();
        }
        function closeSearchModal() {
            document.getElementById('idSearchModal').classList.add('hidden');
        }

        function openMatchSearchModal() {
            document.getElementById('matchSearchModal').classList.remove('hidden');
            document.getElementById('matchIdInput').focus();
        }

        function closeMatchSearchModal() {
            document.getElementById('matchSearchModal').classList.add('hidden');
            document.getElementById('matchModalResultArea').classList.add('hidden');
            document.getElementById('matchIdInput').value = '';
            document.getElementById('matchModalStatus').innerText = '';
        }

        async function doMatchSearch() {
            const mid = document.getElementById('matchIdInput').value.trim();
            const status = document.getElementById('matchModalStatus');
            const resultArea = document.getElementById('matchModalResultArea');
            const t = DICT[currentLang];

            if(!mid) return;

            status.innerText = t.modal_match_loading;
            status.className = "text-xs mb-4 pl-1 text-cyan-400 animate-pulse";
            resultArea.classList.add('hidden');

            try {
                const detail = await robustFetch(`https://www.barmory.net/stb/match/${mid}`);
                const data = detail.Data;
                
                if (detail.WinnerTeam === undefined) {
                    const pValues = Object.values(data);
                    const ref = pValues.find(p => p.NewRating !== undefined && p.OldRating !== undefined);
                    if (ref) {
                        const win = (ref.NewRating - ref.OldRating) >= 0;
                        detail.WinnerTeam = win ? ref.TeamId : (ref.TeamId === 1 ? 0 : 1);
                    }
                }

                const players = Object.entries(data).map(([id, val]) => ({...val, Id: id}));
                const team0Players = players.filter(p => p.TeamId === 0 || p.TeamId === undefined);
                const team1Players = players.filter(p => p.TeamId === 1);

                const renderMiniCard = (p) => {
                    const isWin = p.TeamId === detail.WinnerTeam;
                    return `
                        <div onclick="useFromMatch('${p.Id}')" class="flex items-center justify-between p-3 bg-slate-800/50 hover:bg-cyan-900/30 border border-slate-700 hover:border-cyan-500 rounded-xl cursor-pointer transition group">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-slate-100 group-hover:text-white truncate">${escapeHtml(p.Name || 'Unknown')}</div>
                                <div class="text-[10px] font-mono text-slate-500 group-hover:text-cyan-400/70">ID: ${p.Id}</div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-[10px] font-black ${isWin?'text-cyan-400':'text-red-400'}">${isWin ? t.res_vic : t.res_def}</div>
                                <div class="text-[10px] text-slate-400 font-mono">ELO ${p.NewRating?.toFixed(0) || '---'}</div>
                            </div>
                        </div>
                    `;
                };

                document.getElementById('matchModalTeam0').innerHTML = `<div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Team Alpha</div>` + team0Players.map(renderMiniCard).join('');
                document.getElementById('matchModalTeam1').innerHTML = `<div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Team Bravo</div>` + team1Players.map(renderMiniCard).join('');

                status.innerText = "";
                resultArea.classList.remove('hidden');

            } catch (e) {
                status.innerText = t.modal_match_err;
                status.className = "text-xs mb-4 pl-1 text-red-400";
            }
        }

        function useFromMatch(uid) {
            document.getElementById('steamInput').value = uid;
            closeMatchSearchModal();
            handleCheck();
        }

        async function doNameSearch() {
            const name = document.getElementById('modalSearchInput').value.trim();
            const statusEl = document.getElementById('modalStatusMsg');
            const listEl = document.getElementById('modalResultList');
            const resultEl = document.getElementById('modalFinalResult');
            const t = DICT[currentLang];

            if (!name) return;

            statusEl.innerText = t.modal_status_search;
            statusEl.className = "text-xs text-orange-400 min-h-[1.5rem] mb-2 pl-1 animate-pulse";
            listEl.classList.add('hidden');
            resultEl.classList.add('hidden');
            listEl.innerHTML = '';

            try {
                const url = `https://batrace.aoeiaol.top/api/v1/search/players?q=${encodeURIComponent(name)}&limit=20`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("API Request Failed");
                const data = await response.json();
                const results = data.results || [];

                if (results.length === 0) {
                    statusEl.innerText = t.modal_status_none;
                    statusEl.className = "text-xs text-red-400 min-h-[1.5rem] mb-2 pl-1";
                    return;
                }

                statusEl.innerText = t.modal_status_found.replace('{n}', results.length);
                statusEl.className = "text-xs text-green-400 min-h-[1.5rem] mb-2 pl-1";
                renderPlayerList(results);

            } catch (err) {
                statusEl.innerText = t.modal_status_err + err.message;
                statusEl.className = "text-xs text-red-400 min-h-[1.5rem] mb-2 pl-1";
            }
        }

        function renderPlayerList(players) {
            const listEl = document.getElementById('modalResultList');
            listEl.classList.remove('hidden');

            players.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "search-result-item w-full text-left p-3 rounded-lg bg-slate-800/50 border border-slate-700 transition flex justify-between items-center group";
                const safeName = p.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                btn.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-slate-200 group-hover:text-orange-300 truncate text-sm">${safeName}</div>
                        <div class="flex items-center text-xs text-slate-500 group-hover:text-orange-200/50 font-mono gap-2">
                            <span>ID: ${p.id}</span>
                            <span class="opacity-30">|</span>
                            <span class="text-[10px] opacity-70">Steam: ${p.steam_id}</span>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="text-[10px] px-2 py-0.5 bg-yellow-900/30 text-yellow-500 rounded border border-yellow-900/50">Lv.${p.level}</span>
                    </div>
                `;
                btn.onclick = () => selectPlayerFromSearch(p);
                listEl.appendChild(btn);
            });
        }

        function selectPlayerFromSearch(player) {
            document.getElementById('modalResultList').classList.add('hidden');
            const resultEl = document.getElementById('modalFinalResult');
            resultEl.classList.remove('hidden');
            document.getElementById('modalSelectedName').innerText = player.name;
            document.getElementById('modalSelectedId').innerText = player.id; 
            document.getElementById('modalStatusMsg').innerText = "";
        }

        function useFoundId() {
            const id = document.getElementById('modalSelectedId').innerText;
            if(id) {
                document.getElementById('steamInput').value = id;
                closeSearchModal();
                handleCheck();
            }
        }
    </script>
</body>
</html>

