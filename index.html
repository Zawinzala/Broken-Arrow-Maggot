<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TNMKLQ79MK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-TNMKLQ79MK');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Broken Arrow Maggot Index v3.23 - By Zola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¢åŠ  overflow-x-hidden é˜²æ­¢ç§»åŠ¨ç«¯æ¨ªå‘æ»šåŠ¨ */
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .bar-container { background: rgba(0,0,0,0.5); height: 6px; border-radius: 4px; overflow: hidden; flex: 1; } 
        @media (min-width: 768px) { .bar-container { height: 8px; } }
        
        .bar-kill { background: #22c55e; height: 100%; transition: width 0.6s ease-out; }
        .bar-loss { background: #ef4444; height: 100%; transition: width 0.6s ease-out; }
        .bar-obj { background: #3b82f6; height: 100%; transition: width 0.6s ease-out; }
        
        /* --- ä¿®å¤ï¼šé‡æ–°è¡¥é½è¿›åº¦æ¡èƒŒæ™¯æ ·å¼ --- */
        .load-progress-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; margin: 12px 0; }
        .load-progress-fill { width: 0%; height: 100%; background: #06b6d4; transition: width 0.4s ease; box-shadow: 0 0 15px rgba(6,182,212,0.6); }
        /* ---------------------------------- */

        .maggot-meter-bg { background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%); height: 18px; border-radius: 9px; position: relative; }
        .maggot-indicator { position: absolute; top: -4px; width: 6px; height: 26px; background: white; border: 2px solid #000; transform: translateX(-50%); transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* ä¼˜åŒ–æ ‡ç­¾å®¹å™¨ï¼Œç§»åŠ¨ç«¯ç¼©å°å¹¶è°ƒæ•´ä½ç½® */
        .tag-sticker-container { position: absolute; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; z-index: 30; transform-origin: top right; transform: scale(0.75); pointer-events: none; }
        @media (min-width: 768px) { .tag-sticker-container { top: 1.5rem; right: 1.5rem; gap: 0.75rem; transform: scale(1); } }
        
        .tag-sticker { 
            /* æ–°å¢è¿™ä¸€è¡Œï¼Œå¼ºåˆ¶å¼€å¯é¼ æ ‡äº¤äº’ */
            pointer-events: auto; 
            
            /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
            padding: 0.5rem 1.25rem; 
            border-radius: 0.75rem; 
            font-weight: 900; 
            font-style: italic; 
            font-size: 0.9rem; 
            text-transform: uppercase; 
            transform: rotate(8deg); 
            box-shadow: 0 6px 15px rgba(0,0,0,0.4); 
            border-width: 2px; 
            animation: tagPop 0.5s ease-out forwards; 
            opacity: 0; 
            white-space: nowrap; 
        }
        @keyframes tagPop { from { opacity: 0; transform: scale(0.5) rotate(20deg); } to { opacity: 1; transform: scale(1) rotate(8deg); } }
        
        .teammate-row { transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); min-height: 70px; } 
        @media (min-width: 768px) { .teammate-row { min-height: 85px; } }
        
        .teammate-row:hover { background: rgba(255,255,255,0.05); }
        .is-me { background: rgba(6, 182, 212, 0.15) !important; border-left: 3px solid #06b6d4; }
        @media (min-width: 768px) { .is-me { border-left-width: 5px; } }

        .id-link { cursor: pointer; color: #94a3b8; font-family: ui-monospace, monospace; font-size: 0.7rem; border-bottom: 1px dotted #64748b; width: fit-content; opacity: 0.7; max-width: 100%; overflow: hidden; text-overflow: ellipsis; }
        @media (min-width: 768px) { .id-link { font-size: 0.75rem; } }
        .id-link:hover { color: #22d3ee; border-bottom-color: #22d3ee; opacity: 1; }
        
        .history-chip { font-size: 0.85rem; padding: 6px 14px; background: #1e293b; border: 1px solid #475569; border-radius: 99px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .history-chip:hover { border-color: #06b6d4; color: #22d3ee; background: #0f172a; }
        .history-del { font-size: 1.1rem; line-height: 1; opacity: 0.5; }
        .result-fade { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Modal Styles */
        .modal-backdrop { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        .search-result-item:hover { background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.5); }
        
        .medal-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 2px;
            padding: 2px 4px; 
            border-radius: 4px; 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
            cursor: help;
        }
        @media (min-width: 768px) { .medal-badge { gap: 4px; padding: 2px 6px; border-radius: 6px; } }

        .medal-badge:hover { 
            background: rgba(255,255,255,0.15); 
            transform: translateY(-1px);
            border-color: rgba(255,255,255,0.2);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen pt-4 px-2 pb-24 md:pt-10 md:px-4">

    <div class="w-full max-w-6xl mx-auto flex justify-between items-center mb-6 md:mb-8 px-2">
        <div class="flex gap-4 items-center">
            <div class="text-[10px] md:text-xs text-slate-400 font-mono tracking-widest uppercase font-bold">v3.23 å¹³å±€æ”¯æŒ</div>
        </div>
        <div class="flex gap-1 md:gap-2 bg-slate-800 p-1 rounded-xl border border-slate-700">
            <button onclick="setLang('en')" id="btn_lang_en" class="px-3 py-1 md:px-4 md:py-1.5 text-xs rounded-lg transition font-bold">English</button>
            <button onclick="setLang('zh')" id="btn_lang_zh" class="px-3 py-1 md:px-4 md:py-1.5 text-xs rounded-lg transition font-bold">ä¸­æ–‡</button>
        </div>
    </div>

    <div class="glass-panel w-full max-w-6xl mx-auto rounded-[1.5rem] md:rounded-[2.5rem] p-5 md:p-10 shadow-2xl border-white/5">
        <div class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-6xl font-black text-white tracking-tighter mb-4 flex flex-col md:block items-center justify-center">
                <span id="lbl_title">æ–­ç®­è›†æŒ‡æ•°</span>
                <span class="text-base md:text-xl text-cyan-500 italic mt-2 md:mt-0 md:ml-4 opacity-80 font-serif">By Zola</span>
            </h1>
            <div class="flex justify-center gap-6 mb-4">
                <a href="https://barmory.net/" target="_blank" class="text-xs text-slate-400 border border-slate-700 px-3 py-1 rounded-full hover:bg-slate-700 hover:text-white transition-all font-medium">Data Source: Barmory.net</a>
            </div>
            <p class="text-cyan-400 font-mono text-[10px] md:text-sm uppercase tracking-[0.2em] md:tracking-[0.4em] font-bold" id="lbl_subtitle">Broken Arrow Maggot Index</p>
        </div>

        <div class="flex flex-col items-center mb-10 md:mb-16">
            <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full max-w-2xl relative">
                <input type="text" id="steamInput" class="flex-1 bg-slate-900 border-2 border-slate-700 text-white p-4 md:p-5 rounded-xl md:rounded-2xl text-center text-base md:text-lg focus:ring-4 focus:ring-cyan-500/20 focus:border-cyan-500 outline-none transition-all placeholder-slate-600 shadow-2xl font-medium">
                <button onclick="handleCheck()" id="btn_check" class="bg-cyan-600 hover:bg-cyan-500 text-white font-black px-12 py-4 md:py-5 rounded-xl md:rounded-2xl shadow-xl transform active:scale-95 transition-all text-base md:text-lg whitespace-nowrap">å¼€å§‹æ£€æµ‹</button>
            </div>
            
            <div class="flex flex-row flex-wrap justify-center gap-2 md:gap-6 mt-4">
                <button onclick="openSearchModal()" class="text-slate-400 text-xs md:text-sm hover:text-orange-400 transition flex items-center gap-2 group p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:scale-110 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span id="lbl_find_id_btn" class="border-b border-dotted border-slate-600 group-hover:border-orange-400">ä¸çŸ¥é“ IDï¼Ÿé€šè¿‡ç”¨æˆ·åæŸ¥æ‰¾</span>
                </button>

                <button onclick="openMatchSearchModal()" class="text-slate-400 text-xs md:text-sm hover:text-cyan-400 transition flex items-center gap-2 group p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:scale-110 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <span id="lbl_find_match_btn" class="border-b border-dotted border-slate-600 group-hover:border-cyan-400">åªçŸ¥é“å¯¹å±€ IDï¼Ÿé€šè¿‡å¯¹å±€æŸ¥ç©å®¶</span>
                </button>
            </div>
            
            <div id="historyContainer" class="flex flex-wrap justify-center gap-2 md:gap-3 mt-6 md:mt-8"></div>
        </div>

        <div id="loading" class="hidden text-center py-12 max-w-lg mx-auto">
            <div class="flex justify-between text-sm font-bold text-slate-300 mb-2">
                <span id="loadStatus">Initializing...</span>
                <span id="loadPercent">0%</span>
            </div>
            <div class="load-progress-bg"><div id="loadProgressFill" class="load-progress-fill"></div></div>
            <p class="text-xs text-slate-500 mt-3 font-mono font-medium" id="loadDetail">Synchronizing Data Chains...</p>
        </div>

        <div id="errorArea" class="hidden mb-10 max-w-2xl mx-auto bg-red-900/30 border border-red-500/50 text-red-100 p-6 rounded-3xl text-base text-center font-bold">
            <span id="errorMsg">Unknown Error</span>
        </div>

        <div id="resultPanel" class="hidden result-fade">
            <div class="bg-slate-800/60 rounded-[2rem] md:rounded-[3rem] p-6 md:p-12 border border-white/10 flex flex-col items-center mb-10 md:mb-16 relative overflow-hidden">
                <div class="tag-sticker-container"></div>

                <div class="text-center mb-4 mt-2 md:mt-0 w-full px-2">
                    <div id="userNameDisplay" class="text-xl md:text-3xl font-black text-white mb-2 truncate">Commander Name</div>
                    <div id="calcTimeDisplay" class="text-[10px] font-mono text-slate-500 uppercase tracking-widest">Calculated: 2024-01-01 00:00:00</div>
                </div>

                <h2 class="text-slate-400 text-xs md:text-sm font-black uppercase tracking-[0.2em] mb-2" id="lbl_maggot_index_title">è›†æŒ‡æ•°</h2>
                <div class="text-[6rem] md:text-[10rem] font-black text-white leading-none mb-4 md:mb-6" id="maggotScoreDisplay" style="text-shadow: 0 5px 25px rgba(0,0,0,0.4);">1.0</div>
                <div id="maggotLabel" class="text-xl md:text-3xl font-black px-8 py-2 md:px-10 md:py-3 rounded-full bg-slate-900 border-2 border-white/10 shadow-2xl mb-8 md:mb-12">Unknown</div>
                
                <div class="w-full max-w-3xl mb-8 md:mb-12">
                    <div class="flex justify-between text-[10px] md:text-xs text-slate-400 mb-4 uppercase font-black tracking-widest">
                        <span id="lbl_god_range">ç¥</span><span id="lbl_avg_range">ä¸­åº¸</span><span id="lbl_maggot_range">è›†</span>
                    </div>
                    <div class="maggot-meter-bg"><div id="meterIndicator" class="maggot-indicator" style="left: 0%;"></div></div>
                </div>

                <div class="w-full max-w-5xl grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6 pt-8 md:pt-10 border-t-2 border-white/5">
                    <div class="text-center">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_kdr">å¹³å‡ KD æ’å</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-cyan-400" id="ref_avgKDR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_kr">å¹³å‡å‡»æ€æ’å</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-green-400" id="ref_avgKR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_dr">çˆ±å…µå¦‚å­æ’å</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-red-400" id="ref_avgDR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_or">å¹³å‡å ç‚¹æ’å</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-blue-400" id="ref_avgOR">#0.0</div>
                    </div>
                    <div class="text-center col-span-2 md:col-span-1">
                        <div class="text-[10px] md:text-xs text-slate-500 uppercase font-black mb-1 md:mb-2" id="lbl_ref_wr">æœ€è¿‘ 12 å±€èƒœç‡</div>
                        <div class="text-xl md:text-2xl font-mono font-black text-yellow-400" id="ref_WR">0%</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4 md:gap-6 mb-8 md:mb-12">
                <div class="h-[2px] flex-1 bg-white/10"></div>
                <h3 class="text-lg md:text-2xl font-black text-slate-200 uppercase tracking-widest text-center" id="lbl_history_title">æœ€è¿‘ 12 å±€æœ‰æ•ˆå¯¹å±€</h3>
                <div class="h-[2px] flex-1 bg-white/10"></div>
            </div>
            <div id="matchesContainer" class="space-y-8 md:space-y-16"></div>
        </div>
    </div>

    <div id="idSearchModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 relative shadow-2xl bg-slate-900/90 border border-slate-600">
            <button onclick="closeSearchModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 id="modal_title" class="text-xl md:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500 mb-1 text-center">ç©å®¶å†…éƒ¨ ID æŸ¥è¯¢</h2>
            <div class="text-[10px] text-slate-500 mb-6 text-center font-mono">
                Data from: <a href="https://dash.aoeiaol.top/" target="_blank" class="hover:text-orange-400 border-b border-dotted border-slate-600 transition">https://dash.aoeiaol.top/</a>
            </div>
            
            <div class="flex gap-2 mb-2">
                <input type="text" id="modalSearchInput" 
                    class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-3 placeholder-slate-500" 
                    placeholder="è¾“å…¥æ¸¸æˆç”¨æˆ·å..." 
                    onkeydown="if(event.key === 'Enter') doNameSearch()">
                
                <button onclick="doNameSearch()" id="modal_btn_search"
                    class="text-white bg-orange-600 hover:bg-orange-700 focus:ring-4 focus:outline-none focus:ring-orange-800 font-medium rounded-lg text-sm px-6 py-3 transition whitespace-nowrap">
                    æŸ¥è¯¢
                </button>
            </div>
            <div id="modalStatusMsg" class="text-xs text-slate-400 min-h-[1.5rem] mb-2 pl-1"></div>
            <div id="modalResultList" class="hidden rounded-xl overflow-hidden max-h-[300px] overflow-y-auto flex flex-col gap-1 pr-1 custom-scrollbar"></div>
            <div id="modalFinalResult" class="hidden mt-4 bg-orange-900/10 border border-orange-500/20 rounded-xl p-4 text-center">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider mb-1" id="lbl_modal_pname">ç©å®¶åç§°</div>
                <div id="modalSelectedName" class="text-xl font-bold text-white mb-2"></div>
                <div class="text-slate-400 text-[10px] uppercase tracking-wider mb-1" id="lbl_modal_pid">å†…éƒ¨ ID</div>
                <div class="flex items-center justify-center gap-2 mb-3">
                    <code id="modalSelectedId" class="bg-black/30 px-3 py-1 rounded text-orange-300 font-mono text-xl font-bold select-all"></code>
                </div>
                <button onclick="useFoundId()" id="btn_use_id" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 rounded-lg shadow-lg transition">
                    ä½¿ç”¨æ­¤ ID æ£€æµ‹
                </button>
            </div>
        </div>
    </div>

    <div id="matchSearchModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop p-4">
        <div class="glass-panel w-full max-w-4xl rounded-2xl p-6 relative shadow-2xl bg-slate-900/95 border border-slate-600 flex flex-col max-h-[90vh]">
            <button onclick="closeMatchSearchModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 id="modal_match_title" class="text-xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-6 text-center">é€šè¿‡å¯¹å±€ ID æŸ¥æ‰¾ç©å®¶</h2>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="matchIdInput" 
                    class="bg-slate-800 border border-slate-600 text-white text-sm rounded-xl focus:ring-cyan-500 focus:border-cyan-500 block w-full p-4 placeholder-slate-500 font-mono" 
                    placeholder="è¾“å…¥å¯¹å±€ ID..." 
                    onkeydown="if(event.key === 'Enter') doMatchSearch()">
                
                <button onclick="doMatchSearch()" id="modal_match_btn_search"
                    class="text-white bg-cyan-600 hover:bg-cyan-500 focus:ring-4 focus:outline-none focus:ring-cyan-800 font-bold rounded-xl text-sm px-6 py-4 transition whitespace-nowrap">
                    è·å–æˆ˜ç»©
                </button>
            </div>

            <div id="matchModalStatus" class="text-xs mb-4 pl-1 text-center min-h-[1rem]"></div>

            <div id="matchModalResultArea" class="hidden flex-1 overflow-y-auto custom-scrollbar pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="matchModalTeam0" class="space-y-1"></div>
                    <div id="matchModalTeam1" class="space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            MATCH_GOAL: 12,
            MIN_PLAYERS: 10,
            PROXIES: [
                { name: "Codetabs", url: (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}` },
                { name: "CorsProxy", url: (u) => `https://corsproxy.io/?${encodeURIComponent(u)}` },
                { name: "AllOrigins", url: (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}&cb=${Date.now()}` }
            ]
        };

        const MEDAL_CONFIG = [
            { key: 'Destruction', icon: 'âš”ï¸', color: 'text-red-400' },
            { key: 'Losses', icon: 'â˜ ï¸', color: 'text-gray-400' }, 
            { key: 'DamageDealt', icon: 'ğŸ’¥', color: 'text-orange-400' }, 
            { key: 'DamageReceived', icon: 'ğŸ›¡ï¸', color: 'text-slate-400' }, 
            { key: 'SupplyPointsConsumed', icon: 'ğŸ”', color: 'text-yellow-400' }, 
            { key: 'SupplyPointsConsumedFromAllies', icon: 'ğŸ±', color: 'text-pink-400' }, 
            { key: 'SupplyPointsConsumedByAllies', icon: 'ğŸš‘', color: 'text-green-400' }, 
            { key: 'TotalSpawnedUnitScore', icon: 'ğŸ›’', color: 'text-blue-400' }, 
            { key: 'TotalRefundedUnitScore', icon: 'ğŸ’¸', color: 'text-emerald-400' }
        ];

        const DICT = {
            zh: {
                title: "æ–­ç®­è›†æŒ‡æ•°", subtitle: "Broken Arrow Maggot Index", 
                placeholder: "Steam64 ID æˆ– æ¸¸æˆå†…éƒ¨æ•°å­— ID...", 
                check: "å¼€å§‹æ£€æµ‹", loading: "åŒæ­¥ä¸­...", maggot_index_title: "è›†æŒ‡æ•°",
                god_range: "ç¥", avg_range: " ", maggot_range: "è›†",
                history_title: "æœ€è¿‘ 12 å±€æœ‰æ•ˆå¯¹å±€", 
                find_id_btn: "ä¸çŸ¥é“ IDï¼Ÿé€šè¿‡ç”¨æˆ·åæŸ¥æ‰¾",
                find_match_btn: "åªçŸ¥é“å¯¹å±€ IDï¼Ÿé€šè¿‡å¯¹å±€æŸ¥ç©å®¶",
                modal_title: "ç©å®¶å†…éƒ¨ ID æŸ¥è¯¢", modal_input_ph: "è¾“å…¥æ¸¸æˆç”¨æˆ·å...", modal_btn_search: "æŸ¥è¯¢",
                modal_pname: "ç©å®¶åç§°", modal_pid: "å†…éƒ¨ ID", modal_use_btn: "ä½¿ç”¨æ­¤ ID æ£€æµ‹",
                modal_status_search: "æœç´¢ä¸­...", modal_status_err: "å‡ºé”™äº†: ", modal_status_none: "æœªæ‰¾åˆ°è¯¥ç©å®¶",
                modal_status_found: "æ‰¾åˆ° {n} ä¸ªç»“æœ",
                
                modal_match_title: "é€šè¿‡å¯¹å±€ ID æŸ¥æ‰¾ç©å®¶",
                modal_match_input_ph: "è¾“å…¥å¯¹å±€ ID (å¦‚ 184523)...",
                modal_match_btn_search: "è·å–æˆ˜ç»©",
                modal_match_loading: "æ­£åœ¨è·å–å¯¹å±€ä¿¡æ¯...",
                modal_match_err: "è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ID æ˜¯å¦æ­£ç¡®",

                kill: "å‡»æ€", loss: "æŸå¤±", obj: "å ç‚¹",
                levels: ["ğŸ‘‘ ç¥", "ğŸ¦ å›¢é˜Ÿæ”¯æŸ±", "ğŸ˜ å¹³å¹³æ— å¥‡", "ğŸ› æœ‰ç‚¹è›†", "ğŸ’© è›†ï¼"],
                tag_killer: "âš”ï¸ å‡»æ€ä¸ºä¸»", tag_kd: "ğŸ“ˆ KD ä¸ºä¸»", tag_obj: "ğŸš© å ç‚¹ä¸ºä¸»",
                trend_up: "ğŸš€ æœ€è¿‘å˜å¼º", trend_down: "ğŸ“‰ æœ€è¿‘å˜è›†", trend_flat: "â¡ï¸ ç¨³å¦‚æ³°å±±",
                err_net: "ç½‘ç»œæ‹¥å¡ï¼Œè¯·ç¨åå†è¯•", err_insufficient: "æœ‰æ•ˆå¯¹å±€ä¸è¶³ 12 å±€",
                lbl_ref_kdr: "å¹³å‡ KD æ’å", lbl_ref_kr: "å¹³å‡å‡»æ€æ’å",
                lbl_ref_dr: "çˆ±å…µå¦‚å­æ’å", lbl_ref_or: "å¹³å‡å ç‚¹æ’å", lbl_ref_wr: "æœ€è¿‘ 12 å±€èƒœç‡",
                res_vic: "èƒœåˆ©", res_def: "å¤±è´¥", res_draw: "å¹³å±€",
                meta_map: "åœ°å›¾", meta_dur: "æ—¶é•¿", meta_win: "è·èƒœæ–¹",
                reasons: { 1: "ç»Ÿæ²»ç»“æŸ", 2: "æ­£å¸¸ç»“æŸ", 3: "æŠ•é™ç»“æŸ" },
                medals: {
                    Destruction: "å‡»æ€ç‹", Losses: "é€æ­»ç‹", DamageDealt: "ç‚¸ç‚¸ç‚¸", DamageReceived: "è€ç‚¸ç‹",
                    SupplyPointsConsumed: "å¤§èƒƒè¢‹", SupplyPointsConsumedFromAllies: "å°é¦‹çŒ«", SupplyPointsConsumedByAllies: "å¥¶å¦ˆ", 
                    TotalSpawnedUnitScore: "é‡‡è´­å®˜", TotalRefundedUnitScore: "ä»…é€€æ¬¾"
                },
                // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ æ–°å¢ä»¥ä¸‹å†…å®¹ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
                medal_descs: {
                    Destruction: "å‡»æ€å¾—åˆ†å…¨é˜Ÿæœ€é«˜", 
                    Losses: "æŸå¤±å¾—åˆ†å…¨é˜Ÿæœ€é«˜ (é€åˆ†æœ€å¤š)", 
                    DamageDealt: "å¯¹æ•Œé€ æˆä¼¤å®³æ€»é‡å…¨é˜Ÿæœ€é«˜", 
                    DamageReceived: "æ‰¿å—ä¼¤å®³æ€»é‡å…¨é˜Ÿæœ€é«˜",
                    SupplyPointsConsumed: "æ¶ˆè€—è¡¥ç»™æ€»åˆ†å…¨é˜Ÿæœ€é«˜", 
                    SupplyPointsConsumedFromAllies: "æ¶ˆè€—ç›Ÿå‹è¡¥ç»™åˆ†æ•°å…¨é˜Ÿæœ€é«˜", 
                    SupplyPointsConsumedByAllies: "æä¾›ç»™ç›Ÿå‹è¡¥ç»™åˆ†æ•°å…¨é˜Ÿæœ€é«˜", 
                    TotalSpawnedUnitScore: "æ‹›å‹Ÿå•ä½æ€»åˆ†å…¨é˜Ÿæœ€é«˜", 
                    TotalRefundedUnitScore: "é€€æ¬¾å•ä½æ€»åˆ†å…¨é˜Ÿæœ€é«˜"
                },
                trend_desc: "æœ€è¿‘ 3 å±€æ’åä¸å†å²å¹³å‡æ’åçš„å¯¹æ¯”è¶‹åŠ¿",
                elo_desc: "æœ€æ–°çš„ ELO è¯„åˆ† (åŸºäºæœ€æ–°ä¸€å±€æ•°æ®)",
                // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
            },
            en: {
                title: "Maggot Index", 
                subtitle: "Broken Arrow Performance Index", 
                placeholder: "Steam64 ID or In-Game Numeric ID...", 
                check: "ANALYZE", 
                loading: "Syncing...", 
                maggot_index_title: "MAGGOT INDEX",
                god_range: "GOD", 
                avg_range: " ", 
                maggot_range: "MAGGOT",
                history_title: "Last 12 Valid Matches",
                
                find_id_btn: "Forgot ID? Search by Name",
                find_match_btn: "Have Match ID? Search Players",
                
                modal_title: "Player Internal ID Lookup", 
                modal_input_ph: "Enter Username...", 
                modal_btn_search: "Search",
                modal_pname: "Player Name", 
                modal_pid: "Internal ID", 
                modal_use_btn: "Analyze This ID",
                modal_status_search: "Searching...", 
                modal_status_err: "Error: ", 
                modal_status_none: "No players found",
                modal_status_found: "Found {n} results",

                modal_match_title: "Search Player by Match ID",
                modal_match_input_ph: "Enter Match ID (e.g. 184523)...",
                modal_match_btn_search: "Fetch Stats",
                modal_match_loading: "Retrieving match data...",
                modal_match_err: "Failed to fetch match info",

                kill: "Kills", loss: "Losses", obj: "Caps",
                levels: ["ğŸ‘‘ GODLIKE", "ğŸ¦ CARRY", "ğŸ˜ AVERAGE", "ğŸ› NOOB", "ğŸ’© MAGGOT!"],
                
                // æ ‡ç­¾è¯´æ˜ï¼šPTFO = Play The Objective (åªèµ¢ä¸åˆ·)
                tag_killer: "âš”ï¸ Fragger", 
                tag_kd: "ğŸ“ˆ KD Player", 
                tag_obj: "ğŸš© PTFO", 
                
                trend_up: "ğŸš€ On the Rise", 
                trend_down: "ğŸ“‰ Slumping", 
                trend_flat: "â¡ï¸ Consistent", 
                
                err_net: "Network congestion, please retry", 
                err_insufficient: "Insufficient data (Need 12+ matches)",
                
                lbl_ref_kdr: "KD Rating Rank", 
                lbl_ref_kr: "Kill Rating Rank",
                lbl_ref_dr: "Unit Preservation Rank", 
                lbl_ref_or: "Objective Rank", 
                lbl_ref_wr: "Win Rate (Last 12)",
                
                res_vic: "VICTORY", res_def: "DEFEAT", res_draw: "DRAW",
                meta_map: "Map", meta_dur: "Time", meta_win: "Winner",
                reasons: { 1: "Domination", 2: "Time/Score", 3: "Surrender" },
                
                // --- å¾½ç« è´´çº¸ (çŸ­è¯­) ---
                medals: {
                    // Destruction: å‡»æ€æ€»åˆ†æœ€é«˜ -> Top Fragger (æ¦œä¸€/äººå¤´ç‹)
                    Destruction: "Top Fragger", 
                    // Losses: æŸå¤±æ€»åˆ†æœ€é«˜ -> Cannon Fodder (ç‚®ç°)
                    Losses: "Cannon Fodder",           
                    // DamageDealt: ç‰©ç†ä¼¤å®³æœ€é«˜ -> Heavy Hitter (é‡æ‹³/è¾“å‡ºæœºå™¨)
                    DamageDealt: "Heavy Hitter",       
                    // DamageReceived: æ‰¿ä¼¤æœ€é«˜ -> Sponge (è‚‰ç›¾/å¸ç«æµ·ç»µ) æˆ–è€… Tank
                    DamageReceived: "Bullet Sponge",      
                    // SupplyPointsConsumed: æ¶ˆè€—è¡¥ç»™å¤š -> Big Spender (å¤§æ‰‹å¤§è„š)
                    SupplyPointsConsumed: "Big Spender",   
                    // FromAllies: åƒé˜Ÿå‹è¡¥ç»™ -> Freeloader (ç™½å«–/è¹­åƒè¹­å–)
                    SupplyPointsConsumedFromAllies: "Freeloader", 
                    // ByAllies: ç»™é˜Ÿå‹è¡¥ç»™ -> Medic (è¿™åœ¨æ¸¸æˆåœˆé€šç”¨äºè¾…åŠ©)
                    SupplyPointsConsumedByAllies: "Medic",
                    // TotalSpawned: æ‹›å‹Ÿæ€»åˆ† -> War Machine (æˆ˜äº‰æœºå™¨/æš´å…µ)
                    TotalSpawnedUnitScore: "War Machine",
                    // TotalRefunded: é€€æ¬¾ -> Tactician (æˆ˜æœ¯å®¶/é‡æ–°éƒ¨ç½²) æˆ– Refund King
                    TotalRefundedUnitScore: "Refund King" 
                },
                
                // --- è¯¦ç»†è¯´æ˜ (é¼ æ ‡æ‚¬åœæ˜¾ç¤º) ---
                // è¿™é‡Œçš„ç¿»è¯‘åŠ›æ±‚ç›´ç™½ï¼Œè§£é‡Šæ¸…æ¥šæ•°æ®æ¥æº
                medal_descs: {
                    Destruction: "Highest total value of enemy units destroyed (Raw Kill Score)", 
                    Losses: "Highest total value of own units lost (Feeder)", 
                    DamageDealt: "Highest total physical damage dealt to enemies", 
                    DamageReceived: "Highest total physical damage received",
                    SupplyPointsConsumed: "Most supply points spent on units/ammo", 
                    SupplyPointsConsumedFromAllies: "Most supply taken from teammates' stashes", 
                    SupplyPointsConsumedByAllies: "Most supply provided to teammates", 
                    TotalSpawnedUnitScore: "Highest total point value of units deployed", 
                    TotalRefundedUnitScore: "Highest total point value of units sold back"
                },
                
                trend_desc: "Performance trend over recent matches vs history",
                elo_desc: "Current ELO Rating (Live update)",
            }
        };

        let currentLang = 'zh';
        const HISTORY_KEY = 'ba_maggot_v37_history';

        function setLang(l) {
            currentLang = l; localStorage.setItem('ba_lang', l); updateUIStrings();
        }

        function updateUIStrings() {
            const t = DICT[currentLang];
            document.getElementById('lbl_title').innerText = t.title;
            document.getElementById('lbl_subtitle').innerText = t.subtitle;
            document.getElementById('steamInput').placeholder = t.placeholder;
            document.getElementById('btn_check').innerText = t.check;
            document.getElementById('lbl_maggot_index_title').innerText = t.maggot_index_title;
            document.getElementById('lbl_god_range').innerText = t.god_range;
            document.getElementById('lbl_avg_range').innerText = t.avg_range;
            document.getElementById('lbl_maggot_range').innerText = t.maggot_range;
            document.getElementById('lbl_history_title').innerText = t.history_title;
            document.getElementById('lbl_find_id_btn').innerText = t.find_id_btn;
            document.getElementById('lbl_find_match_btn').innerText = t.find_match_btn;
            document.getElementById('lbl_ref_kdr').innerText = t.lbl_ref_kdr;
            document.getElementById('lbl_ref_kr').innerText = t.lbl_ref_kr;
            document.getElementById('lbl_ref_dr').innerText = t.lbl_ref_dr;
            document.getElementById('lbl_ref_or').innerText = t.lbl_ref_or;
            document.getElementById('lbl_ref_wr').innerText = t.lbl_ref_wr;
            
            document.getElementById('modal_title').innerText = t.modal_title;
            document.getElementById('modalSearchInput').placeholder = t.modal_input_ph;
            document.getElementById('modal_btn_search').innerText = t.modal_btn_search;
            document.getElementById('lbl_modal_pname').innerText = t.modal_pname;
            document.getElementById('lbl_modal_pid').innerText = t.modal_pid;
            document.getElementById('btn_use_id').innerText = t.modal_use_btn;

            document.getElementById('modal_match_title').innerText = t.modal_match_title;
            document.getElementById('matchIdInput').placeholder = t.modal_match_input_ph;
            document.getElementById('modal_match_btn_search').innerText = t.modal_match_btn_search;

            document.getElementById('btn_lang_zh').className = `px-3 py-1 md:px-5 md:py-1.5 text-xs rounded-lg transition font-bold ${currentLang==='zh'?'bg-cyan-600 text-white shadow-lg shadow-cyan-900/40':'text-slate-400 hover:text-white'}`;
            document.getElementById('btn_lang_en').className = `px-3 py-1 md:px-5 md:py-1.5 text-xs rounded-lg transition font-bold ${currentLang==='en'?'bg-cyan-600 text-white shadow-lg shadow-cyan-900/40':'text-slate-400 hover:text-white'}`;
        }

        async function robustFetch(url, attempt = 0) {
            const proxy = CONFIG.PROXIES[attempt % CONFIG.PROXIES.length];
            try {
                const r = await fetch(proxy.url(url));
                if(!r.ok) throw new Error(`HTTP_${r.status}`);
                const d = await r.json();
                return d.contents ? JSON.parse(d.contents) : d;
            } catch (e) {
                if (attempt < 4) return robustFetch(url, attempt + 1);
                throw e;
            }
        }

        window.onload = () => {
            setLang(localStorage.getItem('ba_lang') || 'zh');
            renderHistory();
            const urlId = new URLSearchParams(window.location.search).get('steamId');
            if(urlId) { document.getElementById('steamInput').value=urlId; handleCheck(); }
        };

        function renderHistory() {
            const h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const container = document.getElementById('historyContainer');
            container.innerHTML = h.map(x => `
                <div class="history-chip">
                    <span class="font-bold" onclick="useHistory('${x.id}')">${escapeHtml(x.name)}</span>
                    <span class="history-del cursor-pointer" onclick="event.stopPropagation(); removeHistory('${x.id}')">Ã—</span>
                </div>
            `).join('');
        }
        function useHistory(id) { document.getElementById('steamInput').value = id; handleCheck(); }
        function removeHistory(id) {
            let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            localStorage.setItem(HISTORY_KEY, JSON.stringify(h.filter(x => x.id !== id)));
            renderHistory();
        }

        function updateProgress(percent, status, detail) {
            document.getElementById('loadPercent').innerText = percent + '%';
            document.getElementById('loadProgressFill').style.width = percent + '%';
            document.getElementById('loadStatus').innerText = status;
            document.getElementById('loadDetail').innerText = detail;
        }

        async function handleCheck() {
            const input = document.getElementById('steamInput').value.trim();
            if(!input) return;

            // ============================================
            // Google Analytics Event Tracking
            // ============================================
            if (typeof gtag === 'function') {
                gtag('event', 'search_player', {
                    'search_term': input
                });
            }
            // ============================================

            const t = DICT[currentLang];
            
            document.getElementById('errorArea').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultPanel').classList.add('hidden');
            updateProgress(0, t.loading, "Initializing...");

            try {
                let uid = input;
                let userData = null;
                if (input.length > 10 || isNaN(input)) {
                    updateProgress(5, "Resolving...", "Checking Identity...");
                    userData = await robustFetch(`https://www.barmory.net/stb/commander/${input}/steam`);
                    uid = String(userData.id);
                }

                updateProgress(10, "Scanning...", "Pulling Matches...");
                const timeStr = new Date().toISOString().split('T')[0] + '_' + new Date().getHours().toString().padStart(2,'0');
                const matchList = await robustFetch(`https://www.barmory.net/stb/commander/${uid}/matches?time=${timeStr}`);
                
                const validMatches = [];
                for(let i=0; i < matchList.length && validMatches.length < CONFIG.MATCH_GOAL; i++) {
                    const mId = matchList[i];
                    try {
                        const detail = await robustFetch(`https://www.barmory.net/stb/match/${mId}`);
                        const players = Object.values(detail.Data);
                        const hasEloChange = players.some(p => Math.abs(p.NewRating - p.OldRating) > 0.01);
                        if(players.length >= CONFIG.MIN_PLAYERS && hasEloChange) {
                            validMatches.push({ id: mId, data: detail });
                            const prg = Math.round((validMatches.length / CONFIG.MATCH_GOAL) * 100);
                            updateProgress(prg, `Syncing (${validMatches.length}/12)`, `Match ${mId} OK`);
                        }
                    } catch(e) { console.error(`Match ${mId} Failed`, e); }
                    await new Promise(r => setTimeout(r, 600)); 
                }

                if(validMatches.length < CONFIG.MATCH_GOAL) throw new Error(t.err_insufficient);
                
                const finalMe = validMatches[0].data.Data[uid];
                saveHistory(uid, finalMe?.Name);
                
                document.getElementById('userNameDisplay').innerText = `${finalMe?.Name || 'Unknown'} ${finalMe?.Level ? '(Lv.' + finalMe.Level + ')' : ''}`;
                document.getElementById('calcTimeDisplay').innerText = `Calculated: ${new Date().toLocaleString()}`;

                processFinalData(uid, validMatches);

            } catch (e) {
                document.getElementById('errorArea').classList.remove('hidden');
                document.getElementById('errorMsg').innerText = e.message;
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function formatDuration(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}m ${s}s`;
        }

        function formatMatchTime(ts) {
            const d = new Date(ts * 1000);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        function processFinalData(myUid, matches) {
            let kRankSum = 0, oRankSum = 0, kdRankSum = 0, lossRankSum = 0, wins = 0;
            const medalCounts = {};

            const stats = matches.map(m => {
                const data = m.data.Data;
                const meta = m.data; 

                // --- v3.23 æ··åˆåˆ†é˜Ÿé€»è¾‘ (é€‚é…å¹³å±€) ---
                // 1. é¢„æ‰«æï¼šè®¡ç®—â€œæœ‰åæœ‰å§“â€ç©å®¶çš„ Team 1 å’Œ Team 0 çš„å¹³å‡åˆ†å˜åŒ–
                let t1DeltaSum = 0, t1Count = 0;
                let t0DeltaSum = 0, t0Count = 0;

                Object.values(data).forEach(p => {
                    if (p.Name) { 
                        const d = (p.NewRating || 0) - (p.OldRating || 0);
                        // ä¸¥æ ¼åˆ¤å®šï¼šåªæœ‰ TeamId æ˜ç¡®ä¸º 1 æ‰æ˜¯ 1é˜Ÿï¼Œå…¶ä»–ï¼ˆåŒ…æ‹¬ undefined, 0 ç­‰ï¼‰ç»Ÿç»Ÿç®— 0 é˜Ÿ
                        if (p.TeamId === 1) { 
                            t1DeltaSum += d; t1Count++; 
                        } else { 
                            t0DeltaSum += d; t0Count++; 
                        }
                    }
                });
                
                // è®¡ç®—åŸºå‡†çº¿ (å¦‚æœæŸé˜Ÿæ²¡æ¢æµ‹åˆ°äººï¼Œé»˜è®¤åŸºå‡†ä¸º 0)
                const avgT1 = t1Count > 0 ? t1DeltaSum / t1Count : 0;
                const avgT0 = t0Count > 0 ? t0DeltaSum / t0Count : 0;

                // 2. æ­£å¼æ„å»ºç©å®¶åˆ—è¡¨ (åŒæ—¶ä¿®å¤ TeamId)
                const players = Object.entries(data).map(([key, val]) => {
                    if (!val.Id) val.Id = key;

                    if (val.Name) {
                        // [é€»è¾‘A] æœ‰åå­—çš„ç©å®¶ï¼šä¸¥æ ¼æŒ‰ç…§ TeamId åˆ†é˜Ÿ
                        val.TeamId = (val.TeamId === 1) ? 1 : 0;
                    } else {
                        // [é€»è¾‘B] æ²¡åå­—çš„å¹½çµæ•°æ®ï¼šæ ¹æ® Elo å˜åŒ–æ‰¾â€œé å±±â€
                        val.Name = "Unknown";
                        const myDelta = (val.NewRating || 0) - (val.OldRating || 0);
                        
                        const distT1 = Math.abs(myDelta - avgT1);
                        const distT0 = Math.abs(myDelta - avgT0);
                        
                        if (t1Count === 0 && t0Count === 0) {
                             val.TeamId = myDelta >= 0 ? 1 : 0;
                        } else {
                             val.TeamId = distT1 < distT0 ? 1 : 0;
                        }
                    }
                    return val;
                });

                // ============================================================
                // [v3.23 å¹³å±€é€‚é…] 
                // åªæœ‰å½“ WinnerTeam å®Œå…¨ä¸¢å¤±(undefined)æ—¶ï¼Œæ‰å°è¯•é€šè¿‡ Elo æ¨æ–­èƒœè´Ÿã€‚
                // å¦‚æœæ˜¯ 101ï¼Œåˆ™ä¿ç•™åŸæ ·ï¼Œä½œä¸ºå¹³å±€å¤„ç†ã€‚
                // ============================================================
                if (meta.WinnerTeam === undefined) {
                    let team0EloDelta = 0;
                    let team1EloDelta = 0;
                    players.forEach(p => {
                        if (p.NewRating !== undefined && p.OldRating !== undefined) {
                            const delta = p.NewRating - p.OldRating;
                            if (p.TeamId === 0) team0EloDelta += delta;
                            if (p.TeamId === 1) team1EloDelta += delta;
                        }
                    });
                    // æ¨æ–­èƒœè´Ÿ
                    meta.WinnerTeam = team0EloDelta > team1EloDelta ? 0 : 1;
                }

                const myP = players.find(p => String(p.Id) === String(myUid));
                // å¦‚æœæ‰¾ä¸åˆ°è‡ªå·±ï¼Œä¸”æ˜¯å¹³å±€ï¼Œæš‚å®š Team 0ï¼›å¦åˆ™æŒ‰èƒœè´Ÿé€»è¾‘åˆ†é…
                const myTeamId = myP ? myP.TeamId : (meta.WinnerTeam === 0 ? 1 : 0); 
                
                // --- åˆ¤å®šå¹³å±€ä¸èƒœè´Ÿ ---
                const isDraw = meta.WinnerTeam === 101;
                const isWin = !isDraw && (myTeamId === meta.WinnerTeam);
                
                if(isWin) wins++; // å¹³å±€ä¸è®¡å…¥èƒœåœº

                const maxK = Math.max(...players.map(p => p.DestructionScore || 0), 1);
                const maxL = Math.max(...players.map(p => p.LossesScore || 0), 1);
                const maxO = Math.max(...players.map(p => p.ObjectivesCaptured || 0), 1);
                
                const mapPlayer = (p) => {
                    const k = p.DestructionScore || 0, l = p.LossesScore || 0;
                    return {
                        id: p.Id, name: p.Name, elo: p.NewRating ? p.NewRating.toFixed(0) : "N/A",
                        gain: p.NewRating && p.OldRating ? (p.NewRating - p.OldRating).toFixed(1) : "0.0",
                        kPct: (k / maxK) * 100, lPct: (l / maxL) * 100, oPct: ((p.ObjectivesCaptured || 0) / maxO) * 100,
                        isMe: String(p.Id) === String(myUid),
                        score: (k - l) / 1000 + (p.ObjectivesCaptured || 0),
                        kScore: k, lScore: l, oScore: p.ObjectivesCaptured || 0, kd: k / (l || 1),
                        rawData: p,
                        medals: [] 
                    };
                };

                const ally = players.filter(p => p.TeamId === myTeamId).map(mapPlayer).sort((a,b)=>b.score - a.score);
                const enemy = players.filter(p => p.TeamId !== myTeamId).map(mapPlayer).sort((a,b)=>b.score - a.score);

                const assignMedals = (teamPlayers) => {
                    MEDAL_CONFIG.forEach(def => {
                        const maxVal = Math.max(...teamPlayers.map(p => p.rawData[def.key] || 0));
                        if (maxVal > 0) { 
                            teamPlayers.forEach(p => {
                                if ((p.rawData[def.key] || 0) === maxVal) {
                                    p.medals.push({ ...def, val: maxVal });
                                }
                            });
                        }
                    });
                };
                assignMedals(ally);
                assignMedals(enemy);

                const myP_Mapped = ally.find(p => p.isMe);
                if(myP_Mapped && myP_Mapped.medals) {
                    myP_Mapped.medals.forEach(m => {
                        medalCounts[m.key] = (medalCounts[m.key] || 0) + 1;
                    });
                }

                const calcR = (list, fn) => { 
                    const r = [...list].sort(fn).findIndex(p=>p.isMe) + 1; 
                    return r === 0 ? 5 : r; 
                };

                kRankSum += calcR(ally, (a,b)=>b.kScore - a.kScore);
                oRankSum += calcR(ally, (a,b)=>b.oScore - a.oScore);
                kdRankSum += calcR(ally, (a,b)=>b.kd - a.kd);
                lossRankSum += calcR(ally, (a,b)=>a.lScore - b.lScore);

                let currentMatchRank = ally.findIndex(p => p.isMe) + 1;
                if (currentMatchRank === 0) currentMatchRank = 5;

                return { 
                    id: m.id, 
                    myRank: currentMatchRank, 
                    ally, enemy,
                    isWin: isWin,
                    isDraw: isDraw, // ä¼ é€’å¹³å±€çŠ¶æ€
                    endReason: meta.EndMatchReason,
                    endTime: meta.EndTime,
                    mapId: meta.MapId,
                    duration: meta.TotalPlayTimeInSec,
                    winnerTeam: meta.WinnerTeam
                };
            });

            // æ‰¾å‡ºæœ€å¤šçš„2ä¸ªå¾½ç« 
            const topMedals = Object.entries(medalCounts)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 2)
                .map(x => x[0]);

            renderResults(stats, kRankSum/12, kdRankSum/12, oRankSum/12, lossRankSum/12, wins, topMedals);
        }

        function renderResults(stats, avgKR, avgKDR, avgOR, avgDR, wins, topMedals) {
            const t = DICT[currentLang];
            document.getElementById('resultPanel').classList.remove('hidden');
            
            const avgRank = stats.reduce((a,b) => a + b.myRank, 0) / stats.length; 
            const normalizedRank = (avgRank - 1) / 4; 
            const sCurveValue = (1 - Math.cos(normalizedRank * Math.PI)) / 2; 
            const maggotIndex = (1 + (sCurveValue * 9)).toFixed(1); 

            const display = document.getElementById('maggotScoreDisplay');
            display.innerText = maggotIndex;
            display.style.color = maggotIndex <= 3.5 ? '#4ade80' : (maggotIndex <= 7 ? '#facc15' : '#f87171');
            document.getElementById('maggotLabel').innerText = t.levels[maggotIndex <= 2 ? 0 : (maggotIndex <= 4 ? 1 : (maggotIndex <= 6 ? 2 : (maggotIndex <= 8 ? 3 : 4)))];
            document.getElementById('meterIndicator').style.left = `${((maggotIndex-1)/9)*100}%`;

            document.getElementById('ref_avgKDR').innerText = `#${avgKDR.toFixed(1)}`;
            document.getElementById('ref_avgKR').innerText = `#${avgKR.toFixed(1)}`;
            document.getElementById('ref_avgDR').innerText = `#${avgDR.toFixed(1)}`;
            document.getElementById('ref_avgOR').innerText = `#${avgOR.toFixed(1)}`;
            document.getElementById('ref_WR').innerText = Math.round((wins / stats.length) * 100) + '%';

            // --- æ¸²æŸ“å¾½ç« è´´çº¸ ---
            const container = document.querySelector('.tag-sticker-container');
            container.innerHTML = ''; 

            topMedals.forEach(key => {
                const conf = MEDAL_CONFIG.find(c => c.key === key);
                if(!conf) return;
                
                const dict = DICT[currentLang];
                const name = dict.medals[key] || key;
                // [æ–°å¢] è·å–æè¿°æ–‡æœ¬
                const desc = dict.medal_descs[key] || name;

                // æå–é¢œè‰²å¹¶è®¾ç½®åŠé€æ˜æ ·å¼
                const colorBase = conf.color.replace('text-', '').replace('-400', '');
                const bgClass = `bg-${colorBase}-600/20`;
                const borderClass = `border-${colorBase}-500/50`;
                const textClass = `text-${colorBase}-300`;
                
                const el = document.createElement('div');
                // [æ–°å¢] title å±æ€§å®ç°é¼ æ ‡æ‚¬åœæ˜¾ç¤ºè¯´æ˜
                el.title = desc; 
                el.className = `tag-sticker ${bgClass} ${borderClass} ${textClass} flex items-center gap-2 cursor-help`; // å¢åŠ  cursor-help é¼ æ ‡æ ·å¼
                el.innerHTML = `<span class="text-lg">${conf.icon}</span><span>${name}</span>`;
                container.appendChild(el);
            });

            // æ¸²æŸ“è¶‹åŠ¿æ ‡ç­¾ (Trend Tag)
            const recentAvg = stats.slice(0,3).reduce((a,b)=>a+b.myRank,0)/3;
            const oldAvg = stats.slice(3).reduce((a,b)=>a+b.myRank,0)/9;
            const trendText = recentAvg < oldAvg - 0.4 ? t.trend_up : (recentAvg > oldAvg + 0.4 ? t.trend_down : t.trend_flat);
            
            const trendEl = document.createElement('div');
            // [æ–°å¢] title å±æ€§
            trendEl.title = t.trend_desc;
            trendEl.className = "tag-sticker bg-slate-600/20 border-slate-500/50 text-slate-300 cursor-help";
            trendEl.innerText = trendText;
            container.appendChild(trendEl);

            // ============================================
            // >>> æ–°å¢ï¼šæ¸²æŸ“å½“å‰ Elo æ ‡ç­¾ <<<
            // ============================================
            if (stats.length > 0) {
                const currentMe = stats[0].ally.find(p => p.isMe);
                if (currentMe) {
                    const eloEl = document.createElement('div');
                    // [æ–°å¢] title å±æ€§
                    eloEl.title = t.elo_desc;
                    eloEl.className = "tag-sticker bg-violet-600/20 border-violet-500/50 text-violet-300 font-mono cursor-help";
                    eloEl.innerHTML = `ELO ${currentMe.elo}`;
                    container.appendChild(eloEl);
                }
            }
            // ============================================

            document.getElementById('matchesContainer').innerHTML = stats.map(m => {
                const reasonText = t.reasons[m.endReason] || t.reasons[1];
                const timeText = formatMatchTime(m.endTime);
                const durText = formatDuration(m.duration);
                
                // --- v3.23 UIé€‚é…ï¼šå¹³å±€æ ·å¼ ---
                let resultBadgeColor, resultText;
                
                if (m.isDraw) {
                    // å¹³å±€ï¼šä½¿ç”¨ç°è‰²/Slateè‰²
                    resultBadgeColor = 'bg-slate-600/30 text-slate-300 border border-slate-500/30';
                    resultText = t.res_draw;
                } else {
                    // èƒœè´Ÿï¼šä¿æŒåŸæœ‰é€»è¾‘
                    resultBadgeColor = m.isWin ? 'bg-cyan-600/20 text-cyan-400' : 'bg-red-600/20 text-red-400';
                    resultText = m.isWin ? t.res_vic : t.res_def;
                }
                // ---------------------------

                return `
                <div class="glass-panel rounded-[2rem] md:rounded-[3rem] overflow-hidden border-white/10 shadow-2xl">
                    <div class="bg-white/5 px-4 py-3 md:px-8 md:py-4 flex flex-col md:flex-row justify-between items-start md:items-center text-[10px] md:text-xs font-bold font-mono text-slate-400 gap-2 md:gap-0">
                        <div class="flex flex-wrap items-center gap-2 md:gap-4 leading-relaxed">
                            <span class="whitespace-nowrap">ID: ${m.id}</span>
                            <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                            <span>${timeText}</span>
                            <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                            <span>${t.meta_map} ${m.mapId}</span>
                            <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                            <span>${durText}</span>
                            <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                            <span class="whitespace-nowrap">${reasonText}</span>
                        </div>
                        <span class="px-3 py-1 md:px-4 md:py-1 ${resultBadgeColor} rounded-lg font-black uppercase tracking-widest flex items-center gap-2 self-end md:self-auto">
                            <span>Rank #${m.myRank}</span>
                            <span class="opacity-50">/</span>
                            <span>${resultText}</span>
                        </span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-px bg-white/10">
                        <div class="bg-[#0f172a] p-2 md:p-4">${renderTeam(m.ally, t)}</div>
                        <div class="bg-[#0f172a] p-2 md:p-4">${renderTeam(m.enemy, t)}</div>
                    </div>
                </div>
            `}).join('');
        }

        function renderTeam(players, t) {
            return players.map(p => {
                const hoverDetail = `${t.kill}: ${p.kScore.toLocaleString()} | ${t.loss}: ${p.lScore.toLocaleString()} | ${t.obj}: ${p.oScore}`;
                const medalsHtml = p.medals.length > 0 ? 
                    `<div class="flex flex-wrap gap-1 mt-1.5">${p.medals.map(m => {
                        const mName = t.medals[m.key] || m.key;
                        return `<div class="medal-badge group" title="${mName}: ${Math.round(m.val).toLocaleString()}">
                                <span class="text-[10px] md:text-[12px] filter drop-shadow-md select-none leading-none">${m.icon}</span>
                                <span class="text-[10px] font-bold ${m.color} opacity-90 leading-none whitespace-nowrap">${mName}</span>
                            </div>`;
                    }).join('')}</div>` : '';

                return `
                <div class="teammate-row flex items-center p-2 md:p-3 rounded-xl md:rounded-2xl ${p.isMe?'is-me':''}" title="${hoverDetail}">
                    <div class="flex-1 min-w-0 pr-2 md:pr-4 flex flex-col justify-center">
                        <div class="flex flex-col">
                            <div class="text-xs md:text-sm font-black text-slate-100 truncate mb-0.5">${escapeHtml(p.name)}</div>
                            ${medalsHtml}
                        </div>
                        <div class="id-link mt-1" onclick="inspect('${p.id}')">${p.id}</div>
                    </div>
                    
                    <div class="w-14 md:w-20 text-right mr-2 md:mr-4 font-mono flex-shrink-0">
                        <div class="text-[10px] md:text-xs font-bold text-slate-400">${p.elo}</div>
                        <div class="text-[10px] md:text-[11px] font-black ${parseFloat(p.gain)>=0?'text-green-500':'text-red-500'}">${parseFloat(p.gain)>=0?'+':''}${p.gain}</div>
                    </div>
                    
                    <div class="w-16 md:w-28 space-y-1 flex-shrink-0">
                        <div class="flex items-center gap-1"><div class="bar-container"><div class="bar-kill" style="width:${p.kPct}%"></div></div></div>
                        <div class="flex items-center gap-1"><div class="bar-container"><div class="bar-loss" style="width:${p.lPct}%"></div></div></div>
                        <div class="flex items-center gap-1"><div class="bar-container"><div class="bar-obj" style="width:${p.oPct}%"></div></div></div>
                    </div>
                </div>
            `}).join('');
        }

        function saveHistory(id, name) {
            let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            h = h.filter(x => x.id !== id);
            h.unshift({ id, name: name || id });
            localStorage.setItem(HISTORY_KEY, JSON.stringify(h.slice(0, 10)));
            renderHistory();
        }
        function inspect(id) { 
            const newUrl = window.location.origin + window.location.pathname + '?steamId=' + id;
            window.open(newUrl, '_blank'); 
        }
        function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        function openSearchModal() {
            document.getElementById('idSearchModal').classList.remove('hidden');
            document.getElementById('modalSearchInput').focus();
        }
        function closeSearchModal() {
            document.getElementById('idSearchModal').classList.add('hidden');
        }

        // ============================================
        // [NEW] å¯¹å±€ ID æŸ¥æ‰¾åŠŸèƒ½é€»è¾‘åŒº
        // ============================================
        function openMatchSearchModal() {
            document.getElementById('matchSearchModal').classList.remove('hidden');
            document.getElementById('matchIdInput').focus();
        }

        function closeMatchSearchModal() {
            document.getElementById('matchSearchModal').classList.add('hidden');
            document.getElementById('matchModalResultArea').classList.add('hidden');
            document.getElementById('matchIdInput').value = '';
            document.getElementById('matchModalStatus').innerText = '';
        }

        async function doMatchSearch() {
            const mid = document.getElementById('matchIdInput').value.trim();
            const status = document.getElementById('matchModalStatus');
            const resultArea = document.getElementById('matchModalResultArea');
            const t = DICT[currentLang];

            if(!mid) return;

            status.innerText = t.modal_match_loading;
            status.className = "text-xs mb-4 pl-1 text-cyan-400 animate-pulse";
            resultArea.classList.add('hidden');

            try {
                const detail = await robustFetch(`https://www.barmory.net/stb/match/${mid}`);
                const data = detail.Data;
                
                // åŒæ ·è¿›è¡Œèƒœè´Ÿé€»è¾‘æ¨æ–­ (å‚è€ƒä¹‹å‰çš„ä¿®å¤é€»è¾‘)
                if (detail.WinnerTeam === undefined) {
                    const pValues = Object.values(data);
                    const ref = pValues.find(p => p.NewRating !== undefined && p.OldRating !== undefined);
                    if (ref) {
                        const win = (ref.NewRating - ref.OldRating) >= 0;
                        detail.WinnerTeam = win ? ref.TeamId : (ref.TeamId === 1 ? 0 : 1);
                    }
                }

                const players = Object.entries(data).map(([id, val]) => ({...val, Id: id}));
                const team0Players = players.filter(p => p.TeamId === 0 || p.TeamId === undefined);
                const team1Players = players.filter(p => p.TeamId === 1);

                const renderMiniCard = (p) => {
                    const isWin = p.TeamId === detail.WinnerTeam;
                    return `
                        <div onclick="useFromMatch('${p.Id}')" class="flex items-center justify-between p-3 bg-slate-800/50 hover:bg-cyan-900/30 border border-slate-700 hover:border-cyan-500 rounded-xl cursor-pointer transition group">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-slate-100 group-hover:text-white truncate">${escapeHtml(p.Name || 'Unknown')}</div>
                                <div class="text-[10px] font-mono text-slate-500 group-hover:text-cyan-400/70">ID: ${p.Id}</div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-[10px] font-black ${isWin?'text-cyan-400':'text-red-400'}">${isWin ? t.res_vic : t.res_def}</div>
                                <div class="text-[10px] text-slate-400 font-mono">ELO ${p.NewRating?.toFixed(0) || '---'}</div>
                            </div>
                        </div>
                    `;
                };

                document.getElementById('matchModalTeam0').innerHTML = `<div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Team Alpha</div>` + team0Players.map(renderMiniCard).join('');
                document.getElementById('matchModalTeam1').innerHTML = `<div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Team Bravo</div>` + team1Players.map(renderMiniCard).join('');

                status.innerText = "";
                resultArea.classList.remove('hidden');

            } catch (e) {
                status.innerText = t.modal_match_err;
                status.className = "text-xs mb-4 pl-1 text-red-400";
            }
        }

        // ä»å¯¹å±€åˆ—è¡¨é€‰ä¸­ç©å®¶å¹¶è§¦å‘ä¸»æ£€æµ‹
        function useFromMatch(uid) {
            document.getElementById('steamInput').value = uid;
            closeMatchSearchModal();
            handleCheck();
        }
        // ============================================

        async function doNameSearch() {
            const name = document.getElementById('modalSearchInput').value.trim();
            const statusEl = document.getElementById('modalStatusMsg');
            const listEl = document.getElementById('modalResultList');
            const resultEl = document.getElementById('modalFinalResult');
            const t = DICT[currentLang];

            if (!name) return;

            statusEl.innerText = t.modal_status_search;
            statusEl.className = "text-xs text-orange-400 min-h-[1.5rem] mb-2 pl-1 animate-pulse";
            listEl.classList.add('hidden');
            resultEl.classList.add('hidden');
            listEl.innerHTML = '';

            try {
                const url = `https://batrace.aoeiaol.top/api/v1/search/players?q=${encodeURIComponent(name)}&limit=20`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("API Request Failed");
                const data = await response.json();
                const results = data.results || [];

                if (results.length === 0) {
                    statusEl.innerText = t.modal_status_none;
                    statusEl.className = "text-xs text-red-400 min-h-[1.5rem] mb-2 pl-1";
                    return;
                }

                statusEl.innerText = t.modal_status_found.replace('{n}', results.length);
                statusEl.className = "text-xs text-green-400 min-h-[1.5rem] mb-2 pl-1";
                renderPlayerList(results);

            } catch (err) {
                statusEl.innerText = t.modal_status_err + err.message;
                statusEl.className = "text-xs text-red-400 min-h-[1.5rem] mb-2 pl-1";
            }
        }

        function renderPlayerList(players) {
            const listEl = document.getElementById('modalResultList');
            listEl.classList.remove('hidden');

            players.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "search-result-item w-full text-left p-3 rounded-lg bg-slate-800/50 border border-slate-700 transition flex justify-between items-center group";
                const safeName = p.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                btn.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-slate-200 group-hover:text-orange-300 truncate text-sm">${safeName}</div>
                        <div class="flex items-center text-xs text-slate-500 group-hover:text-orange-200/50 font-mono gap-2">
                            <span>ID: ${p.id}</span>
                            <span class="opacity-30">|</span>
                            <span class="text-[10px] opacity-70">Steam: ${p.steam_id}</span>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="text-[10px] px-2 py-0.5 bg-yellow-900/30 text-yellow-500 rounded border border-yellow-900/50">Lv.${p.level}</span>
                    </div>
                `;
                btn.onclick = () => selectPlayerFromSearch(p);
                listEl.appendChild(btn);
            });
        }

        function selectPlayerFromSearch(player) {
            document.getElementById('modalResultList').classList.add('hidden');
            const resultEl = document.getElementById('modalFinalResult');
            resultEl.classList.remove('hidden');
            document.getElementById('modalSelectedName').innerText = player.name;
            document.getElementById('modalSelectedId').innerText = player.id; 
            document.getElementById('modalStatusMsg').innerText = "";
        }

        function useFoundId() {
            const id = document.getElementById('modalSelectedId').innerText;
            if(id) {
                document.getElementById('steamInput').value = id;
                closeSearchModal();
                handleCheck();
            }
        }
    </script>
</body>
</html>

