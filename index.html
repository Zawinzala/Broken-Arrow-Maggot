<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broken Arrow Maggot Index v3.13 - By Zola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .bar-container { background: rgba(0,0,0,0.5); height: 8px; border-radius: 4px; overflow: hidden; flex: 1; }
        .bar-kill { background: #22c55e; height: 100%; transition: width 0.6s ease-out; }
        .bar-loss { background: #ef4444; height: 100%; transition: width 0.6s ease-out; }
        .bar-obj { background: #3b82f6; height: 100%; transition: width 0.6s ease-out; }
        .load-progress-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; margin: 12px 0; }
        .load-progress-fill { width: 0%; height: 100%; background: #06b6d4; transition: width 0.4s ease; box-shadow: 0 0 15px rgba(6,182,212,0.6); }
        .maggot-meter-bg { background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%); height: 18px; border-radius: 9px; position: relative; }
        .maggot-indicator { position: absolute; top: -4px; width: 6px; height: 26px; background: white; border: 2px solid #000; transform: translateX(-50%); transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .tag-sticker-container { position: absolute; top: 1.5rem; right: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; align-items: flex-end; z-index: 30; }
        .tag-sticker { padding: 0.5rem 1.25rem; border-radius: 0.75rem; font-weight: 900; font-style: italic; font-size: 0.9rem; text-transform: uppercase; transform: rotate(8deg); box-shadow: 0 6px 15px rgba(0,0,0,0.4); border-width: 2px; animation: tagPop 0.5s ease-out forwards; opacity: 0; }
        @keyframes tagPop { from { opacity: 0; transform: scale(0.5) rotate(20deg); } to { opacity: 1; transform: scale(1) rotate(8deg); } }
        .teammate-row { transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); min-height: 85px; }
        .teammate-row:hover { background: rgba(255,255,255,0.05); }
        .is-me { background: rgba(6, 182, 212, 0.15) !important; border-left: 5px solid #06b6d4; }
        .id-link { cursor: pointer; color: #94a3b8; font-family: ui-monospace, monospace; font-size: 0.75rem; border-bottom: 1px dotted #64748b; width: fit-content; opacity: 0.7; }
        .id-link:hover { color: #22d3ee; border-bottom-color: #22d3ee; opacity: 1; }
        .history-chip { font-size: 0.85rem; padding: 6px 14px; background: #1e293b; border: 1px solid #475569; border-radius: 99px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .history-chip:hover { border-color: #06b6d4; color: #22d3ee; background: #0f172a; }
        .history-del { font-size: 1.1rem; line-height: 1; opacity: 0.5; }
        .result-fade { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Modal Styles */
        .modal-backdrop { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        .search-result-item:hover { background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.5); }
        
        .medal-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px;
            padding: 2px 6px; 
            border-radius: 6px; 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
            cursor: help;
        }
        .medal-badge:hover { 
            background: rgba(255,255,255,0.15); 
            transform: translateY(-1px);
            border-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="min-h-screen pt-10 px-4 pb-24">

    <div class="w-full max-w-6xl mx-auto flex justify-between items-center mb-8 px-2">
        <div class="flex gap-4 items-center">
            <div class="text-xs text-slate-400 font-mono tracking-widest uppercase font-bold">v3.13 Integrated Edition</div>
        </div>
        <div class="flex gap-2 bg-slate-800 p-1.5 rounded-xl border border-slate-700">
            <button onclick="setLang('en')" id="btn_lang_en" class="px-4 py-1.5 text-xs rounded-lg transition font-bold">English</button>
            <button onclick="setLang('zh')" id="btn_lang_zh" class="px-4 py-1.5 text-xs rounded-lg transition font-bold">ä¸­æ–‡</button>
        </div>
    </div>

    <div class="glass-panel w-full max-w-6xl mx-auto rounded-[2.5rem] p-10 shadow-2xl border-white/5">
        <div class="text-center mb-12">
            <h1 class="text-6xl font-black text-white tracking-tighter mb-4">
                <span id="lbl_title">æ–­ç®­è›†æŒ‡æ•°</span>
                <span class="text-xl text-cyan-500 italic ml-4 opacity-80 font-serif">By Zola</span>
            </h1>
            <div class="flex justify-center gap-6 mb-4">
                <a href="https://barmory.net/" target="_blank" class="text-xs text-slate-400 border border-slate-700 px-3 py-1 rounded-full hover:bg-slate-700 hover:text-white transition-all font-medium">Data Source: Barmory.net</a>
            </div>
            <p class="text-cyan-400 font-mono text-sm uppercase tracking-[0.4em] font-bold" id="lbl_subtitle">Broken Arrow Maggot Index</p>
        </div>

        <div class="flex flex-col items-center mb-16">
            <div class="flex flex-col md:flex-row gap-4 w-full max-w-2xl relative">
                <input type="text" id="steamInput" class="flex-1 bg-slate-900 border-2 border-slate-700 text-white p-5 rounded-2xl text-center text-lg focus:ring-4 focus:ring-cyan-500/20 focus:border-cyan-500 outline-none transition-all placeholder-slate-600 shadow-2xl font-medium">
                <button onclick="handleCheck()" id="btn_check" class="bg-cyan-600 hover:bg-cyan-500 text-white font-black px-12 py-5 rounded-2xl shadow-xl transform active:scale-95 transition-all text-lg whitespace-nowrap">å¼€å§‹æ£€æµ‹</button>
            </div>
            <button onclick="openSearchModal()" class="mt-3 text-slate-400 text-sm hover:text-orange-400 transition flex items-center gap-2 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:scale-110 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <span id="lbl_find_id_btn" class="border-b border-dotted border-slate-600 group-hover:border-orange-400">ä¸çŸ¥é“ IDï¼Ÿé€šè¿‡ç”¨æˆ·åæŸ¥æ‰¾</span>
            </button>
            
            <div id="historyContainer" class="flex flex-wrap justify-center gap-3 mt-8"></div>
        </div>

        <div id="loading" class="hidden text-center py-12 max-w-lg mx-auto">
            <div class="flex justify-between text-sm font-bold text-slate-300 mb-2">
                <span id="loadStatus">Initializing...</span>
                <span id="loadPercent">0%</span>
            </div>
            <div class="load-progress-bg"><div id="loadProgressFill" class="load-progress-fill"></div></div>
            <p class="text-xs text-slate-500 mt-3 font-mono font-medium" id="loadDetail">Synchronizing Data Chains...</p>
        </div>

        <div id="errorArea" class="hidden mb-10 max-w-2xl mx-auto bg-red-900/30 border border-red-500/50 text-red-100 p-6 rounded-3xl text-base text-center font-bold">
            <span id="errorMsg">Unknown Error</span>
        </div>

        <div id="resultPanel" class="hidden result-fade">
            <div class="bg-slate-800/60 rounded-[3rem] p-12 border border-white/10 flex flex-col items-center mb-16 relative overflow-hidden">
                <div class="tag-sticker-container">
                    <div id="styleTag" class="tag-sticker bg-cyan-900 border-cyan-400 text-cyan-50 text-xl"></div>
                    <div id="trendTag" class="tag-sticker bg-slate-700 border-slate-400 text-slate-100"></div>
                </div>

                <div class="text-center mb-4">
                    <div id="userNameDisplay" class="text-3xl font-black text-white mb-1">Commander Name</div>
                    <div id="calcTimeDisplay" class="text-[10px] font-mono text-slate-500 uppercase tracking-widest">Calculated: 2024-01-01 00:00:00</div>
                </div>

                <h2 class="text-slate-400 text-sm font-black uppercase tracking-[0.2em] mb-2" id="lbl_maggot_index_title">è›†æŒ‡æ•°</h2>
                <div class="text-[10rem] font-black text-white leading-none mb-6" id="maggotScoreDisplay" style="text-shadow: 0 10px 50px rgba(0,0,0,0.4);">1.0</div>
                <div id="maggotLabel" class="text-3xl font-black px-10 py-3 rounded-full bg-slate-900 border-2 border-white/10 shadow-2xl mb-12">Unknown</div>
                
                <div class="w-full max-w-3xl mb-12">
                    <div class="flex justify-between text-xs text-slate-400 mb-4 uppercase font-black tracking-widest">
                        <span id="lbl_god_range">ç¥</span><span id="lbl_avg_range">ä¸­åº¸</span><span id="lbl_maggot_range">è›†</span>
                    </div>
                    <div class="maggot-meter-bg"><div id="meterIndicator" class="maggot-indicator" style="left: 0%;"></div></div>
                </div>

                <div class="w-full max-w-5xl grid grid-cols-2 md:grid-cols-5 gap-6 pt-10 border-t-2 border-white/5">
                    <div class="text-center">
                        <div class="text-xs text-slate-500 uppercase font-black mb-2" id="lbl_ref_kdr">å¹³å‡ KD æ’å</div>
                        <div class="text-2xl font-mono font-black text-cyan-400" id="ref_avgKDR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500 uppercase font-black mb-2" id="lbl_ref_kr">å¹³å‡å‡»æ€æ’å</div>
                        <div class="text-2xl font-mono font-black text-green-400" id="ref_avgKR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500 uppercase font-black mb-2" id="lbl_ref_dr">çˆ±å…µå¦‚å­æ’å</div>
                        <div class="text-2xl font-mono font-black text-red-400" id="ref_avgDR">#0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-500 uppercase font-black mb-2" id="lbl_ref_or">å¹³å‡å ç‚¹æ’å</div>
                        <div class="text-2xl font-mono font-black text-blue-400" id="ref_avgOR">#0.0</div>
                    </div>
                    <div class="text-center col-span-2 md:col-span-1">
                        <div class="text-xs text-slate-500 uppercase font-black mb-2" id="lbl_ref_wr">æœ€è¿‘ 12 å±€èƒœç‡</div>
                        <div class="text-2xl font-mono font-black text-yellow-400" id="ref_WR">0%</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-6 mb-12">
                <div class="h-[2px] flex-1 bg-white/10"></div>
                <h3 class="text-2xl font-black text-slate-200 uppercase tracking-widest" id="lbl_history_title">æœ€è¿‘ 12 å±€æœ‰æ•ˆå¯¹å±€</h3>
                <div class="h-[2px] flex-1 bg-white/10"></div>
            </div>
            <div id="matchesContainer" class="space-y-16"></div>
        </div>
    </div>

    <div id="idSearchModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 relative shadow-2xl bg-slate-900/90 border border-slate-600">
            <button onclick="closeSearchModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 id="modal_title" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500 mb-1 text-center">ç©å®¶å†…éƒ¨ ID æŸ¥è¯¢</h2>
            <div class="text-[10px] text-slate-500 mb-6 text-center font-mono">
                Data from: <a href="https://dash.aoeiaol.top/" target="_blank" class="hover:text-orange-400 border-b border-dotted border-slate-600 transition">https://dash.aoeiaol.top/</a>
            </div>
            
            <div class="flex gap-2 mb-2">
                <input type="text" id="modalSearchInput" 
                    class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-3 placeholder-slate-500" 
                    placeholder="è¾“å…¥æ¸¸æˆç”¨æˆ·å..." 
                    onkeydown="if(event.key === 'Enter') doNameSearch()">
                
                <button onclick="doNameSearch()" id="modal_btn_search"
                    class="text-white bg-orange-600 hover:bg-orange-700 focus:ring-4 focus:outline-none focus:ring-orange-800 font-medium rounded-lg text-sm px-6 py-3 transition whitespace-nowrap">
                    æŸ¥è¯¢
                </button>
            </div>
            <div id="modalStatusMsg" class="text-xs text-slate-400 min-h-[1.5rem] mb-2 pl-1"></div>

            <div id="modalResultList" class="hidden rounded-xl overflow-hidden max-h-[300px] overflow-y-auto flex flex-col gap-1 pr-1 custom-scrollbar"></div>

            <div id="modalFinalResult" class="hidden mt-4 bg-orange-900/10 border border-orange-500/20 rounded-xl p-4 text-center">
                <div class="text-slate-400 text-[10px] uppercase tracking-wider mb-1" id="lbl_modal_pname">ç©å®¶åç§°</div>
                <div id="modalSelectedName" class="text-xl font-bold text-white mb-2"></div>
                
                <div class="text-slate-400 text-[10px] uppercase tracking-wider mb-1" id="lbl_modal_pid">å†…éƒ¨ ID</div>
                <div class="flex items-center justify-center gap-2 mb-3">
                    <code id="modalSelectedId" class="bg-black/30 px-3 py-1 rounded text-orange-300 font-mono text-xl font-bold select-all"></code>
                </div>
                
                <button onclick="useFoundId()" id="btn_use_id" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 rounded-lg shadow-lg transition">
                    ä½¿ç”¨æ­¤ ID æ£€æµ‹
                </button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            MATCH_GOAL: 12,
            MIN_PLAYERS: 10,
            PROXIES: [
                { name: "Codetabs", url: (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}` },
                { name: "CorsProxy", url: (u) => `https://corsproxy.io/?${encodeURIComponent(u)}` },
                { name: "AllOrigins", url: (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}&cb=${Date.now()}` }
            ]
        };

        const MEDAL_CONFIG = [
            { key: 'Destruction', icon: 'âš”ï¸', color: 'text-red-400' },
            { key: 'Losses', icon: 'â˜ ï¸', color: 'text-gray-400' }, 
            { key: 'DamageDealt', icon: 'ğŸ’¥', color: 'text-orange-400' }, 
            { key: 'DamageReceived', icon: 'ğŸ›¡ï¸', color: 'text-slate-400' }, 
            { key: 'SupplyPointsConsumed', icon: 'ğŸ”', color: 'text-yellow-400' }, 
            { key: 'SupplyPointsConsumedFromAllies', icon: 'ğŸ±', color: 'text-pink-400' }, 
            { key: 'SupplyPointsConsumedByAllies', icon: 'ğŸš‘', color: 'text-green-400' }, 
            { key: 'TotalSpawnedUnitScore', icon: 'ğŸ›’', color: 'text-blue-400' }, 
            { key: 'TotalRefundedUnitScore', icon: 'ğŸ’¸', color: 'text-emerald-400' }
        ];

        const DICT = {
            zh: {
                title: "æ–­ç®­è›†æŒ‡æ•°", subtitle: "Broken Arrow Maggot Index", 
                placeholder: "Steam64 ID æˆ– æ¸¸æˆå†…éƒ¨æ•°å­— ID...", // ä¿®æ”¹ 1
                check: "å¼€å§‹æ£€æµ‹", loading: "åŒæ­¥ä¸­...", maggot_index_title: "è›†æŒ‡æ•°",
                god_range: "ç¥", avg_range: "ä¸­åº¸", maggot_range: "è›†",
                history_title: "æœ€è¿‘ 12 å±€æœ‰æ•ˆå¯¹å±€", 
                find_id_btn: "ä¸çŸ¥é“ IDï¼Ÿé€šè¿‡ç”¨æˆ·åæŸ¥æ‰¾",
                // Modal
                modal_title: "ç©å®¶å†…éƒ¨ ID æŸ¥è¯¢", modal_input_ph: "è¾“å…¥æ¸¸æˆç”¨æˆ·å...", modal_btn_search: "æŸ¥è¯¢",
                modal_pname: "ç©å®¶åç§°", modal_pid: "å†…éƒ¨ ID", modal_use_btn: "ä½¿ç”¨æ­¤ ID æ£€æµ‹",
                modal_status_search: "æœç´¢ä¸­...", modal_status_err: "å‡ºé”™äº†: ", modal_status_none: "æœªæ‰¾åˆ°è¯¥ç©å®¶",
                modal_status_found: "æ‰¾åˆ° {n} ä¸ªç»“æœ",
                
                kill: "å‡»æ€", loss: "æŸå¤±", obj: "å ç‚¹",
                levels: ["ğŸ‘‘ ç¥", "ğŸ¦ å›¢é˜Ÿæ”¯æŸ±", "ğŸ˜ å¹³å¹³æ— å¥‡", "ğŸ› æœ‰ç‚¹è›†", "ğŸ’© è›†ï¼"],
                tag_killer: "âš”ï¸ å‡»æ€ä¸ºä¸»", tag_kd: "ğŸ“ˆ KD ä¸ºä¸»", tag_obj: "ğŸš© å ç‚¹ä¸ºä¸»",
                trend_up: "ğŸš€ æœ€è¿‘çŒ›å¦‚è™", trend_down: "ğŸ“‰ æœ€è¿‘å˜è›†äº†", trend_flat: "â¡ï¸ ç¨³å¦‚æ³°å±±",
                err_net: "ç½‘ç»œæ‹¥å¡ï¼Œè¯·ç¨åå†è¯•", err_insufficient: "æœ‰æ•ˆå¯¹å±€ä¸è¶³ 12 å±€",
                lbl_ref_kdr: "å¹³å‡ KD æ’å", lbl_ref_kr: "å¹³å‡å‡»æ€æ’å",
                lbl_ref_dr: "çˆ±å…µå¦‚å­æ’å", lbl_ref_or: "å¹³å‡å ç‚¹æ’å", lbl_ref_wr: "æœ€è¿‘ 12 å±€èƒœç‡",
                res_vic: "èƒœåˆ©", res_def: "å¤±è´¥",
                meta_map: "åœ°å›¾", meta_dur: "æ—¶é•¿", meta_win: "è·èƒœæ–¹",
                reasons: { 1: "ç»Ÿæ²»ç»“æŸ", 2: "æ­£å¸¸ç»“æŸ", 3: "æŠ•é™ç»“æŸ" },
                medals: {
                    Destruction: "å‡»æ€ç‹",
                    Losses: "é€æ­»ç‹",
                    DamageDealt: "ç‚¸ç‚¸ç‚¸",
                    DamageReceived: "æœ€è€ç‚¸",
                    SupplyPointsConsumed: "å¤§èƒƒè¢‹",
                    SupplyPointsConsumedFromAllies: "å°é¦‹çŒ«",
                    SupplyPointsConsumedByAllies: "å¥¶å¦ˆ", 
                    TotalSpawnedUnitScore: "é‡‡è´­å®˜",
                    TotalRefundedUnitScore: "ä»…é€€æ¬¾"
                }
            },
            en: {
                title: "Maggot Index", subtitle: "Broken Arrow Performance Index", 
                placeholder: "Steam64 ID or In-Game Numeric ID...", // ä¿®æ”¹ 1
                check: "ANALYZE", loading: "Syncing...", maggot_index_title: "MAGGOT INDEX",
                god_range: "GOD", avg_range: "AVG", maggot_range: "MAGGOT",
                history_title: "Last 12 Valid Matches",
                find_id_btn: "Don't know ID? Search by Name",
                // Modal
                modal_title: "Player Internal ID Search", modal_input_ph: "Enter Username...", modal_btn_search: "Search",
                modal_pname: "Player Name", modal_pid: "Internal ID", modal_use_btn: "Use This ID",
                modal_status_search: "Searching...", modal_status_err: "Error: ", modal_status_none: "No players found",
                modal_status_found: "Found {n} results",

                kill: "Kill", loss: "Loss", obj: "OBJ",
                levels: ["ğŸ‘‘ GOD", "ğŸ¦ Pillar", "ğŸ˜ Average", "ğŸ› Bit Maggot", "ğŸ’© Maggot!"],
                tag_killer: "âš”ï¸ Kill Focus", tag_kd: "ğŸ“ˆ KD Focus", tag_obj: "ğŸš© Obj Focus",
                trend_up: "ğŸš€ Improving", trend_down: "ğŸ“‰ Getting Worse", trend_flat: "â¡ï¸ Stable",
                err_net: "Network error, please retry", err_insufficient: "Insufficient valid matches",
                lbl_ref_kdr: "Avg KD Rank", lbl_ref_kr: "Avg Kill Rank",
                lbl_ref_dr: "Troop Care Rank", lbl_ref_or: "Avg Obj Rank", lbl_ref_wr: "Win Rate (12G)",
                res_vic: "VICTORY", res_def: "DEFEAT",
                meta_map: "Map", meta_dur: "Dur", meta_win: "Winner",
                reasons: { 1: "Domination", 2: "Normal", 3: "Surrender" },
                medals: {
                    Destruction: "Kill King",
                    Losses: "Loss King",
                    DamageDealt: "Top DMG",
                    DamageReceived: "Iron Wall",
                    SupplyPointsConsumed: "Hungry",
                    SupplyPointsConsumedFromAllies: "Leech",
                    SupplyPointsConsumedByAllies: "Medic", 
                    TotalSpawnedUnitScore: "Spender",
                    TotalRefundedUnitScore: "Refunder"
                }
            }
        };

        let currentLang = 'zh';
        const HISTORY_KEY = 'ba_maggot_v37_history';

        function setLang(l) {
            currentLang = l; localStorage.setItem('ba_lang', l); updateUIStrings();
        }

        function updateUIStrings() {
            const t = DICT[currentLang];
            // Main UI
            document.getElementById('lbl_title').innerText = t.title;
            document.getElementById('lbl_subtitle').innerText = t.subtitle;
            document.getElementById('steamInput').placeholder = t.placeholder;
            document.getElementById('btn_check').innerText = t.check;
            document.getElementById('lbl_maggot_index_title').innerText = t.maggot_index_title;
            document.getElementById('lbl_god_range').innerText = t.god_range;
            document.getElementById('lbl_avg_range').innerText = t.avg_range;
            document.getElementById('lbl_maggot_range').innerText = t.maggot_range;
            document.getElementById('lbl_history_title').innerText = t.history_title;
            document.getElementById('lbl_find_id_btn').innerText = t.find_id_btn;
            document.getElementById('lbl_ref_kdr').innerText = t.lbl_ref_kdr;
            document.getElementById('lbl_ref_kr').innerText = t.lbl_ref_kr;
            document.getElementById('lbl_ref_dr').innerText = t.lbl_ref_dr;
            document.getElementById('lbl_ref_or').innerText = t.lbl_ref_or;
            document.getElementById('lbl_ref_wr').innerText = t.lbl_ref_wr;
            
            // Modal UI
            document.getElementById('modal_title').innerText = t.modal_title;
            document.getElementById('modalSearchInput').placeholder = t.modal_input_ph;
            document.getElementById('modal_btn_search').innerText = t.modal_btn_search;
            document.getElementById('lbl_modal_pname').innerText = t.modal_pname;
            document.getElementById('lbl_modal_pid').innerText = t.modal_pid;
            document.getElementById('btn_use_id').innerText = t.modal_use_btn;

            document.getElementById('btn_lang_zh').className = `px-5 py-1.5 text-xs rounded-lg transition font-bold ${currentLang==='zh'?'bg-cyan-600 text-white shadow-lg shadow-cyan-900/40':'text-slate-400 hover:text-white'}`;
            document.getElementById('btn_lang_en').className = `px-5 py-1.5 text-xs rounded-lg transition font-bold ${currentLang==='en'?'bg-cyan-600 text-white shadow-lg shadow-cyan-900/40':'text-slate-400 hover:text-white'}`;
        }

        // --- Core Fetch Logic ---
        async function robustFetch(url, attempt = 0) {
            const proxy = CONFIG.PROXIES[attempt % CONFIG.PROXIES.length];
            try {
                const r = await fetch(proxy.url(url));
                if(!r.ok) throw new Error(`HTTP_${r.status}`);
                const d = await r.json();
                return d.contents ? JSON.parse(d.contents) : d;
            } catch (e) {
                if (attempt < 4) return robustFetch(url, attempt + 1);
                throw e;
            }
        }

        window.onload = () => {
            setLang(localStorage.getItem('ba_lang') || 'zh');
            renderHistory();
            const urlId = new URLSearchParams(window.location.search).get('steamId');
            if(urlId) { document.getElementById('steamInput').value=urlId; handleCheck(); }
        };

        // --- History Logic ---
        function renderHistory() {
            const h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const container = document.getElementById('historyContainer');
            container.innerHTML = h.map(x => `
                <div class="history-chip">
                    <span class="font-bold" onclick="useHistory('${x.id}')">${escapeHtml(x.name)}</span>
                    <span class="history-del cursor-pointer" onclick="event.stopPropagation(); removeHistory('${x.id}')">Ã—</span>
                </div>
            `).join('');
        }
        function useHistory(id) { document.getElementById('steamInput').value = id; handleCheck(); }
        function removeHistory(id) {
            let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            localStorage.setItem(HISTORY_KEY, JSON.stringify(h.filter(x => x.id !== id)));
            renderHistory();
        }

        function updateProgress(percent, status, detail) {
            document.getElementById('loadPercent').innerText = percent + '%';
            document.getElementById('loadProgressFill').style.width = percent + '%';
            document.getElementById('loadStatus').innerText = status;
            document.getElementById('loadDetail').innerText = detail;
        }

        // --- Main Analysis Logic ---
        async function handleCheck() {
            const input = document.getElementById('steamInput').value.trim();
            if(!input) return;
            const t = DICT[currentLang];
            
            document.getElementById('errorArea').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultPanel').classList.add('hidden');
            updateProgress(0, t.loading, "Initializing...");

            try {
                let uid = input;
                let userData = null;
                // If Steam64 ID (17 digits) or input seems not like a simple integer ID
                if (input.length > 10 || isNaN(input)) {
                    updateProgress(5, "Resolving...", "Checking Identity...");
                    userData = await robustFetch(`https://www.barmory.net/stb/commander/${input}/steam`);
                    uid = String(userData.id);
                }

                updateProgress(10, "Scanning...", "Pulling Matches...");
                const timeStr = new Date().toISOString().split('T')[0] + '_' + new Date().getHours().toString().padStart(2,'0');
                const matchList = await robustFetch(`https://www.barmory.net/stb/commander/${uid}/matches?time=${timeStr}`);
                
                const validMatches = [];
                for(let i=0; i < matchList.length && validMatches.length < CONFIG.MATCH_GOAL; i++) {
                    const mId = matchList[i];
                    try {
                        const detail = await robustFetch(`https://www.barmory.net/stb/match/${mId}`);
                        const players = Object.values(detail.Data);
                        const hasEloChange = players.some(p => Math.abs(p.NewRating - p.OldRating) > 0.01);
                        if(players.length >= CONFIG.MIN_PLAYERS && hasEloChange) {
                            validMatches.push({ id: mId, data: detail });
                            const prg = Math.round((validMatches.length / CONFIG.MATCH_GOAL) * 100);
                            updateProgress(prg, `Syncing (${validMatches.length}/12)`, `Match ${mId} OK`);
                        }
                    } catch(e) { console.error(`Match ${mId} Failed`, e); }
                    await new Promise(r => setTimeout(r, 600)); 
                }

                if(validMatches.length < CONFIG.MATCH_GOAL) throw new Error(t.err_insufficient);
                
                const finalMe = validMatches[0].data.Data[uid];
                saveHistory(uid, finalMe?.Name);
                
                document.getElementById('userNameDisplay').innerText = `${finalMe?.Name || 'Unknown'} ${finalMe?.Level ? '(Lv.' + finalMe.Level + ')' : ''}`;
                document.getElementById('calcTimeDisplay').innerText = `Calculated: ${new Date().toLocaleString()}`;

                processFinalData(uid, validMatches);

            } catch (e) {
                document.getElementById('errorArea').classList.remove('hidden');
                document.getElementById('errorMsg').innerText = e.message;
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function formatDuration(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}m ${s}s`;
        }

        function formatMatchTime(ts) {
            const d = new Date(ts * 1000);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        function processFinalData(myUid, matches) {
            let kRankSum = 0, oRankSum = 0, kdRankSum = 0, lossRankSum = 0, wins = 0;

            const stats = matches.map(m => {
                const data = m.data.Data;
                const meta = m.data; 
                const me = data[myUid];
                const myTeamId = me.TeamId;
                const players = Object.values(data);
                
                const isWin = myTeamId === meta.WinnerTeam;
                if(isWin) wins++;

                const maxK = Math.max(...players.map(p => p.DestructionScore || 0), 1);
                const maxL = Math.max(...players.map(p => p.LossesScore || 0), 1);
                const maxO = Math.max(...players.map(p => p.ObjectivesCaptured || 0), 1);
                
                const mapPlayer = (p) => {
                    const k = p.DestructionScore || 0, l = p.LossesScore || 0;
                    return {
                        id: p.Id, name: p.Name || 'Unknown', elo: p.NewRating.toFixed(0),
                        gain: (p.NewRating - p.OldRating).toFixed(1),
                        kPct: (k / maxK) * 100, lPct: (l / maxL) * 100, oPct: ((p.ObjectivesCaptured || 0) / maxO) * 100,
                        isMe: String(p.Id) === String(myUid),
                        score: (k - l) / 1000 + (p.ObjectivesCaptured || 0),
                        kScore: k, lScore: l, oScore: p.ObjectivesCaptured || 0, kd: k / (l || 1),
                        rawData: p,
                        medals: [] 
                    };
                };

                const ally = players.filter(p => p.TeamId === myTeamId).map(mapPlayer).sort((a,b)=>b.score - a.score);
                const enemy = players.filter(p => p.TeamId !== myTeamId).map(mapPlayer).sort((a,b)=>b.score - a.score);

                const assignMedals = (teamPlayers) => {
                    MEDAL_CONFIG.forEach(def => {
                        const maxVal = Math.max(...teamPlayers.map(p => p.rawData[def.key] || 0));
                        if (maxVal > 0) { 
                            teamPlayers.forEach(p => {
                                if ((p.rawData[def.key] || 0) === maxVal) {
                                    p.medals.push({ ...def, val: maxVal });
                                }
                            });
                        }
                    });
                };
                assignMedals(ally);
                assignMedals(enemy);

                kRankSum += ([...ally].sort((a,b)=>b.kScore - a.kScore).findIndex(p=>p.isMe) + 1);
                oRankSum += ([...ally].sort((a,b)=>b.oScore - a.oScore).findIndex(p=>p.isMe) + 1);
                kdRankSum += ([...ally].sort((a,b)=>b.kd - a.kd).findIndex(p=>p.isMe) + 1);
                lossRankSum += ([...ally].sort((a,b)=>a.lScore - b.lScore).findIndex(p=>p.isMe) + 1);

                return { 
                    id: m.id, 
                    myRank: ally.findIndex(p => p.isMe) + 1, 
                    ally, enemy,
                    isWin: isWin,
                    endReason: meta.EndMatchReason,
                    endTime: meta.EndTime,
                    mapId: meta.MapId,
                    duration: meta.TotalPlayTimeInSec,
                    winnerTeam: meta.WinnerTeam
                };
            });
            renderResults(stats, kRankSum/12, kdRankSum/12, oRankSum/12, lossRankSum/12, wins);
        }

        function renderResults(stats, avgKR, avgKDR, avgOR, avgDR, wins) {
            const t = DICT[currentLang];
            document.getElementById('resultPanel').classList.remove('hidden');
            
            const avgRank = stats.reduce((a,b) => a + b.myRank, 0) / stats.length; 
            const normalizedRank = (avgRank - 1) / 4; 
            const sCurveValue = (1 - Math.cos(normalizedRank * Math.PI)) / 2; 
            const maggotIndex = (1 + (sCurveValue * 9)).toFixed(1); 

            const display = document.getElementById('maggotScoreDisplay');
            display.innerText = maggotIndex;
            display.style.color = maggotIndex <= 3.5 ? '#4ade80' : (maggotIndex <= 7 ? '#facc15' : '#f87171');
            document.getElementById('maggotLabel').innerText = t.levels[maggotIndex <= 2 ? 0 : (maggotIndex <= 4 ? 1 : (maggotIndex <= 6 ? 2 : (maggotIndex <= 8 ? 3 : 4)))];
            document.getElementById('meterIndicator').style.left = `${((maggotIndex-1)/9)*100}%`;

            document.getElementById('ref_avgKDR').innerText = `#${avgKDR.toFixed(1)}`;
            document.getElementById('ref_avgKR').innerText = `#${avgKR.toFixed(1)}`;
            document.getElementById('ref_avgDR').innerText = `#${avgDR.toFixed(1)}`;
            document.getElementById('ref_avgOR').innerText = `#${avgOR.toFixed(1)}`;
            document.getElementById('ref_WR').innerText = Math.round((wins / stats.length) * 100) + '%';

            const minRank = Math.min(avgKR, avgKDR, avgOR);
            const styleEl = document.getElementById('styleTag');
            if (avgKR === minRank) styleEl.innerText = t.tag_killer;
            else if (avgKDR === minRank) styleEl.innerText = t.tag_kd;
            else styleEl.innerText = t.tag_obj;

            const recentAvg = stats.slice(0,3).reduce((a,b)=>a+b.myRank,0)/3;
            const oldAvg = stats.slice(3).reduce((a,b)=>a+b.myRank,0)/9;
            document.getElementById('trendTag').innerText = recentAvg < oldAvg - 0.4 ? t.trend_up : (recentAvg > oldAvg + 0.4 ? t.trend_down : t.trend_flat);

            document.getElementById('matchesContainer').innerHTML = stats.map(m => {
                const reasonText = t.reasons[m.endReason] || t.reasons[1];
                const timeText = formatMatchTime(m.endTime);
                const durText = formatDuration(m.duration);
                const resultBadgeColor = m.isWin ? 'bg-cyan-600/20 text-cyan-400' : 'bg-red-600/20 text-red-400';
                const resultText = m.isWin ? t.res_vic : t.res_def;

                return `
                <div class="glass-panel rounded-[3rem] overflow-hidden border-white/10 shadow-2xl">
                    <div class="bg-white/5 px-8 py-4 flex justify-between items-center text-xs font-bold font-mono text-slate-400">
                        <div class="flex items-center gap-4">
                            <span>MATCH ID: ${m.id}</span>
                            <span class="w-px h-3 bg-white/10"></span>
                            <span>${timeText}</span>
                            <span class="w-px h-3 bg-white/10"></span>
                            <span>${t.meta_map} ${m.mapId}</span>
                            <span class="w-px h-3 bg-white/10"></span>
                            <span>${durText}</span>
                            <span class="w-px h-3 bg-white/10"></span>
                            <span>${reasonText}</span>
                        </div>
                        <span class="px-4 py-1 ${resultBadgeColor} rounded-lg font-black uppercase tracking-widest flex items-center gap-2">
                            <span>Rank #${m.myRank}</span>
                            <span class="opacity-50">/</span>
                            <span>${resultText}</span>
                        </span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-px bg-white/10">
                        <div class="bg-[#0f172a] p-4">${renderTeam(m.ally, t)}</div>
                        <div class="bg-[#0f172a] p-4">${renderTeam(m.enemy, t)}</div>
                    </div>
                </div>
            `}).join('');
        }

        function renderTeam(players, t) {
            return players.map(p => {
                const hoverDetail = `${t.kill}: ${p.kScore.toLocaleString()} | ${t.loss}: ${p.lScore.toLocaleString()} | ${t.obj}: ${p.oScore}`;
                const medalsHtml = p.medals.length > 0 ? 
                    `<div class="flex flex-wrap gap-1.5 mt-1.5">${p.medals.map(m => {
                        const mName = t.medals[m.key] || m.key;
                        return `<div class="medal-badge group" title="${mName}: ${Math.round(m.val).toLocaleString()}">
                                <span class="text-[12px] filter drop-shadow-md select-none leading-none">${m.icon}</span>
                                <span class="hidden xl:inline text-[10px] font-bold ${m.color} opacity-90 leading-none whitespace-nowrap">${mName}</span>
                            </div>`;
                    }).join('')}</div>` : '';

                return `
                <div class="teammate-row flex items-center p-3 rounded-2xl ${p.isMe?'is-me':''}" title="${hoverDetail}">
                    <div class="flex-1 min-w-0 pr-4 flex flex-col justify-center">
                        <div class="flex flex-col">
                            <div class="text-sm font-black text-slate-100 truncate leading-tight tracking-tight">${escapeHtml(p.name)}</div>
                            ${medalsHtml}
                        </div>
                        <div class="id-link mt-1.5" onclick="inspect('${p.id}')">${p.id}</div>
                    </div>
                    <div class="w-20 text-right mr-4 font-mono">
                        <div class="text-xs font-bold text-slate-400">${p.elo}</div>
                        <div class="text-[11px] font-black ${parseFloat(p.gain)>=0?'text-green-500':'text-red-500'}">${parseFloat(p.gain)>=0?'+':''}${p.gain}</div>
                    </div>
                    <div class="w-28 space-y-1.5">
                        <div class="flex items-center gap-2"><div class="bar-container"><div class="bar-kill" style="width:${p.kPct}%"></div></div></div>
                        <div class="flex items-center gap-2"><div class="bar-container"><div class="bar-loss" style="width:${p.lPct}%"></div></div></div>
                        <div class="flex items-center gap-2"><div class="bar-container"><div class="bar-obj" style="width:${p.oPct}%"></div></div></div>
                    </div>
                </div>
            `}).join('');
        }

        function saveHistory(id, name) {
            let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            h = h.filter(x => x.id !== id);
            h.unshift({ id, name: name || id });
            localStorage.setItem(HISTORY_KEY, JSON.stringify(h.slice(0, 10)));
            renderHistory();
        }
        function inspect(id) { 
            const newUrl = window.location.origin + window.location.pathname + '?steamId=' + id;
            window.open(newUrl, '_blank'); 
        }
        function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        // --- NEW MODAL LOGIC ---
        function openSearchModal() {
            document.getElementById('idSearchModal').classList.remove('hidden');
            document.getElementById('modalSearchInput').focus();
        }
        function closeSearchModal() {
            document.getElementById('idSearchModal').classList.add('hidden');
        }
        async function doNameSearch() {
            const name = document.getElementById('modalSearchInput').value.trim();
            const statusEl = document.getElementById('modalStatusMsg');
            const listEl = document.getElementById('modalResultList');
            const resultEl = document.getElementById('modalFinalResult');
            const t = DICT[currentLang];

            if (!name) return;

            statusEl.innerText = t.modal_status_search;
            statusEl.className = "text-xs text-orange-400 min-h-[1.5rem] mb-2 pl-1 animate-pulse";
            listEl.classList.add('hidden');
            resultEl.classList.add('hidden');
            listEl.innerHTML = '';

            try {
                const url = `https://batrace.aoeiaol.top/api/v1/search/players?q=${encodeURIComponent(name)}&limit=20`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("API Request Failed");
                const data = await response.json();
                const results = data.results || [];

                if (results.length === 0) {
                    statusEl.innerText = t.modal_status_none;
                    statusEl.className = "text-xs text-red-400 min-h-[1.5rem] mb-2 pl-1";
                    return;
                }

                statusEl.innerText = t.modal_status_found.replace('{n}', results.length);
                statusEl.className = "text-xs text-green-400 min-h-[1.5rem] mb-2 pl-1";
                renderPlayerList(results);

            } catch (err) {
                statusEl.innerText = t.modal_status_err + err.message;
                statusEl.className = "text-xs text-red-400 min-h-[1.5rem] mb-2 pl-1";
            }
        }

        function renderPlayerList(players) {
            const listEl = document.getElementById('modalResultList');
            listEl.classList.remove('hidden');

            players.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "search-result-item w-full text-left p-3 rounded-lg bg-slate-800/50 border border-slate-700 transition flex justify-between items-center group";
                const safeName = p.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                // ä¿®æ”¹ 3: å¢åŠ  Steam ID æ˜¾ç¤º
                btn.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-slate-200 group-hover:text-orange-300 truncate text-sm">${safeName}</div>
                        <div class="flex items-center text-xs text-slate-500 group-hover:text-orange-200/50 font-mono gap-2">
                            <span>ID: ${p.id}</span>
                            <span class="opacity-30">|</span>
                            <span class="text-[10px] opacity-70">Steam: ${p.steam_id}</span>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="text-[10px] px-2 py-0.5 bg-yellow-900/30 text-yellow-500 rounded border border-yellow-900/50">Lv.${p.level}</span>
                    </div>
                `;
                btn.onclick = () => selectPlayerFromSearch(p);
                listEl.appendChild(btn);
            });
        }

        function selectPlayerFromSearch(player) {
            document.getElementById('modalResultList').classList.add('hidden');
            const resultEl = document.getElementById('modalFinalResult');
            resultEl.classList.remove('hidden');
            document.getElementById('modalSelectedName').innerText = player.name;
            document.getElementById('modalSelectedId').innerText = player.id; 
            document.getElementById('modalStatusMsg').innerText = "";
        }

        function useFoundId() {
            const id = document.getElementById('modalSelectedId').innerText;
            if(id) {
                document.getElementById('steamInput').value = id;
                closeSearchModal();
                handleCheck();
            }
        }
    </script>
</body>
</html>